---
title: "Churchill CO2 Data Analysis"
author: "Dani Trangmoe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# add root directory here for github
```

Notes:

```{r, include=FALSE}
rm(list = ls())
Sys.setenv(TZ = "UTC")

library(data.table)
library(ggplot2)
library(cowplot)
library(openair)
library(plotrix) # standard error function
library(signal)
library(svMisc)
library(zoo)
library(stringr)
library(plyr)
library(viridis)
library(lubridate)
library(tidyverse)
library(gridExtra) 
library(plotly)
library(RColorBrewer)
library(pracma)
library(cowplot)
library(nlme)
library(gt)
```

# Load data

```{r}

df = fread('C:/Users/dtrangmoe/Documents/Churchill/Data/Churchill_Merged_CF1_CF3_HH_24.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))

#needs continuous day variable
df_avg = fread('C:/Users/dtrangmoe/Documents/Churchill/Data/Churchill_Merged_Avg_CF1_CF3_HH_24.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))


```

#### Create yearly dataframes, timestamp

```{r}

#Creates data frames of each year containing the daily averages of each value- useful for focusing on one year at a time

df_avg$day <- as.POSIXct(df_avg$date, format = "%Y-%m-%d")
df$day <- as.POSIXct(df$date, format = "%Y-%m-%d")

df$DOY <- yday(df$TIMESTAMP)
df_avg$DOY <- yday(df_avg$TIMESTAMP)

#2023
df_2023 <- df %>%
  filter(year(date) == 2023)
df_avg_2023 <- df_avg %>%
  filter(year(date) == 2023)

#2024
df_2024 <- subset(df, ((df$TIMESTAMP > as.POSIXct("2024-01-01 00:00")) & (df$TIMESTAMP < as.POSIXct("2024-09-16 00:00"))))

df_avg_2024 <- subset(df_avg, ((df_avg$TIMESTAMP > as.POSIXct("2024-01-01 00:00")) & (df_avg$TIMESTAMP < as.POSIXct("2024-09-16 00:00"))))

#Both (using Sept. 15th Date)
df_avg_23_24 <- subset(df_avg, ((df_avg$TIMESTAMP > as.POSIXct("2022-09-15 00:00")) & (df_avg$TIMESTAMP < as.POSIXct("2024-09-16 00:00"))))

df_23_24 <- subset(df, ((df$TIMESTAMP > as.POSIXct("2022-09-15 00:00")) & (df$TIMESTAMP < as.POSIXct("2024-09-16 00:00"))))

## For two year budget

df_y1 <- subset(df, ((df$TIMESTAMP > as.POSIXct("2022-09-15 00:00")) & (df$TIMESTAMP < as.POSIXct("2023-09-16 00:00"))))

df_y2 <- subset(df, ((df$TIMESTAMP >= as.POSIXct("2023-09-16 00:00")) & (df$TIMESTAMP < as.POSIXct("2024-09-16 00:00"))))



```


### Timeseries plot


Plot 1 on ameriflux poster; timeseries of GPP, ER, NEE, and CH4

```{r}


ggplot(data = df_avg_2023, aes(x=day))+
  theme_bw()+
  geom_point(aes(y = -GPP_F*60*60*24*(1/1000000)*12, color = "GPP"))+
  geom_point(aes(y = RECO*60*60*24*(1/1000000)*12, color = "Respiration")) +
  geom_line(aes(y = FC_F*60*60*24*(1/1000000)*12, color = "NEE"))+
  geom_line(aes(y = FCH4_F*60*60*24*(1/1000000000)*12*13, color = "CH4"))+
  geom_hline(yintercept=0, col="black")+
  scale_y_continuous(expression('CO'[2]*' Flux (g C'~m^-2~d^-1*')'),
  sec.axis = sec_axis(~ . /13, name = expression('CH'[4]*' Flux (g C'~m^-2~d^-1*')')))+
  scale_color_manual(name = " ",
            values = c("GPP" = "navy", 
                      "Respiration" = "turquoise3", 
                      "NEE" = "salmon", 
                      "CH4" = "mediumorchid"),
            breaks = c("GPP", "Respiration", "NEE", "CH4"))

ggplot(data = df_avg_2023, aes(x=day))+
  theme_bw()+
  geom_point(aes(y = -GPP_F*60*60*24*(1/1000000)*12, color = "GPP"))+
  geom_point(aes(y = RECO*60*60*24*(1/1000000)*12, color = "Respiration")) +
  geom_line(aes(y = FC_F*60*60*24*(1/1000000)*12, color = "NEE"))+
  geom_line(aes(y = FCH4_F*60*60*24*(1/1000000000)*12*13, color = "CH4"))+
  geom_hline(yintercept=0, col="black")+
  scale_y_continuous(expression('CO'[2]*' Flux (g C'~m^-2~d^-1*')'),
  sec.axis = sec_axis(~ . /13, name = expression('CH'[4]*' Flux (g C'~m^-2~d^-1*')')))+
  scale_color_manual(name = " ",
            values = c("GPP" = "navy", 
                      "Respiration" = "turquoise3", 
                      "NEE" = "salmon", 
                      "CH4" = "mediumorchid"),
            breaks = c("GPP", "Respiration", "NEE", "CH4"))


ggplot(data = df_avg_23_24, aes(x=day))+
  theme_bw()+
  geom_point(aes(y = -GPP_F*60*60*24*(1/1000000)*12, color = "GPP"))+
  geom_point(aes(y = RECO*60*60*24*(1/1000000)*12, color = "Respiration")) +
  geom_line(aes(y = FC_F*60*60*24*(1/1000000)*12, color = "NEE"))+
  geom_line(aes(y = FCH4_F*60*60*24*(1/1000000000)*12*13, color = "CH4"))+
  geom_hline(yintercept=0, col="black")+
  scale_y_continuous(expression('CO'[2]*' Flux (g C'~m^-2~d^-1*')'),
  sec.axis = sec_axis(~ . /13, name = expression('CH'[4]*' Flux (g C'~m^-2~d^-1*')')))+
  scale_color_manual(name = " ",
            values = c("GPP" = "navy", 
                      "Respiration" = "turquoise3", 
                      "NEE" = "salmon", 
                      "CH4" = "mediumorchid"),
            breaks = c("GPP", "Respiration", "NEE", "CH4"))+
  scale_x_datetime(limits = as.POSIXct(c('2022-09-15', '2024-09-15')))

```



#### Gap Filling Plot

Shows gap in flux data and compares gap filled and non-gap filled data

```{r}

#Uses Half-Hourly data

ggplot(data = df_2023)+
  geom_hline(yintercept = 0)+
  geom_point(aes(TIMESTAMP,FC_F,col='Gapfilled'))+
  geom_point(aes(TIMESTAMP,FC,col='Original'))+
  scale_y_continuous(limits=c(-7,6))+
  scale_x_datetime(limits = as.POSIXct(c('2023-01-01','2023-12-01'),format="%F"))+
  labs(y = "CO2 Flux ", x = "Time") +
  scale_color_manual(values=c('red','black'))+
  geom_vline(xintercept = as.POSIXct("2023-07-05"))

ggplot(data = df_2024)+
  geom_hline(yintercept = 0)+
  geom_point(aes(TIMESTAMP,FC_F,col='Gapfilled'))+
  geom_point(aes(TIMESTAMP,FC,col='Original'))+
  scale_y_continuous(limits=c(-7,6))+
  scale_x_datetime(limits = as.POSIXct(c('2024-01-01','2024-12-01'),format="%F"))+
  labs(y = "CO2 Flux ", x = "Time") +
  scale_color_manual(values=c('red','black'))+
  geom_vline(xintercept = as.POSIXct("2024-07-05"))


```


#### Net C Budget

Plot 2 in Ameriflux poster

_no_NAs is used for other years of data where NAs are present in gapfilled data

2023
```{r}

# Units start as micromoles of CO2/(m^2s), converted to Grams of C/m^2

# Net CO2 Flux
df_2023 <- df_2023 %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F * 60 * (1/1000000) * 12 * 30))


# Units start as nanomoles of CH4/(m^2s), converted to Grams of C/m^2

#Net CH4 Flux
df_2023 <- df_2023 %>%
  mutate(FCH4_F_no_NAs = ifelse(is.na(FCH4_F), 0, FCH4_F*60*(1/1000000000)*12*30))


## Summation of data
net_CO2 <- sum(df_2023$FC_F_no_NAs)
net_CH4 <- sum(df_2023$FCH4_F_no_NAs) 


## Marco uses g CH4 not g C, gets a value of ~11 for CH4 in 2023

# Used IPCC Sixth Assessment Report (AR6) global warming potentials, 100 year time period - could use paper gwp* or delta equation for future analysis

net_CH4_CO2e <- net_CH4*27.2
sum = net_CO2+net_CH4


#Dataframe created to generate bar graph
net_wp_2023 <- data.frame(
  Category = c("CO2", "CH4", "Total"),
  Value = c(round(net_CO2, 2), round(net_CH4, 2), round(sum, 2) 
))

#Plot here

ggplot(net_wp_2023, aes(x = Category, y = Value)) +
  theme_bw()+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  geom_hline(yintercept=0, colour = "black")+
  labs(
    x = "",
    y = expression("Net Carbon Flux (g C"~m^-2~y^-1*")")) +
  geom_label(aes(label = Value), vjust = ifelse(net_wp_2023$Value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(-16, 13))


```

2024
```{r}

# Units start as micromoles of CO2/(m^2s), converted to Grams of C/m^2

# Net CO2 Flux
df_2024 <- df_2024 %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F * 60 * (1/1000000) * 12 * 30))


# Units start as nanomoles of CH4/(m^2s), converted to Grams of C/m^2

#Net CH4 Flux
df_2024 <- df_2024 %>%
  mutate(FCH4_F_no_NAs = ifelse(is.na(FCH4_F), 0, FCH4_F*60*(1/1000000000)*12*30))


## Summation of data
net_CO2 <- sum(df_2024$FC_F_no_NAs)
net_CH4 <- sum(df_2024$FCH4_F_no_NAs) 


## Marco uses g CH4 not g C, gets a value of ~11 for CH4 in 2024

# Used IPCC Sixth Assessment Report (AR6) global warming potentials, 100 year time period - could use paper gwp* or delta equation for future analysis

net_CH4_CO2e <- net_CH4*27.2
sum = net_CO2+net_CH4


#Dataframe created to generate bar graph
net_wp_2024 <- data.frame(
  Category = c("CO2", "CH4", "Total"),
  Value = c(round(net_CO2, 2), round(net_CH4, 2), round(sum, 2) 
))

#Plot here

ggplot(net_wp_2024, aes(x = Category, y = Value)) +
  theme_bw()+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  geom_hline(yintercept=0, colour = "black")+
  labs(
    x = "",
    y = expression("Net Carbon Flux (g C"~m^-2~y^-1*")")) +
  geom_label(aes(label = Value), vjust = ifelse(net_wp_2024$Value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(-40, 15))


```


Y1
```{r}

# Units start as micromoles of CO2/(m^2s), converted to Grams of C/m^2

# Net CO2 Flux
df_y1 <- df_y1 %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F * 60 * (1/1000000) * 12 * 30))


# Units start as nanomoles of CH4/(m^2s), converted to Grams of C/m^2

#Net CH4 Flux
df_y1 <- df_y1 %>%
  mutate(FCH4_F_no_NAs = ifelse(is.na(FCH4_F), 0, FCH4_F*60*(1/1000000000)*12*30))


## Summation of data
net_CO2 <- sum(df_y1$FC_F_no_NAs)
net_CH4 <- sum(df_y1$FCH4_F_no_NAs) 


## Marco uses g CH4 not g C, gets a value of ~11 for CH4 in 2023

# Used IPCC Sixth Assessment Report (AR6) global warming potentials, 100 year time period - could use paper gwp* or delta equation for future analysis

net_CH4_CO2e <- net_CH4*27.2
sum = net_CO2+net_CH4


#Dataframe created to generate bar graph
net_wp <- data.frame(
  Category = c("Total", "CO2", "CH4"),
  Value = c(round(sum, 2), round(net_CO2, 2), round(net_CH4, 2) 
))

#Plot here

ggplot(net_wp, aes(y = Category, x = Value)) +
  theme_bw()+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  geom_vline(xintercept=0, colour = "black")+
  labs(
    y = "",
    x = expression("Net Carbon Flux (g C"~m^-2~y^-1*")"),
    title = "Year 1: Sept. 15th, 2022 to Sept 15th, 2023") +
  geom_label(aes(label = Value), hjust = ifelse(net_wp$Value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_x_continuous(limits=c(-25, 13))


```


Y2
```{r}

# Units start as micromoles of CO2/(m^2s), converted to Grams of C/m^2

# Net CO2 Flux
df_y2 <- df_y2 %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F * 60 * (1/1000000) * 12 * 30))


# Units start as nanomoles of CH4/(m^2s), converted to Grams of C/m^2

#Net CH4 Flux
df_y2 <- df_y2 %>%
  mutate(FCH4_F_no_NAs = ifelse(is.na(FCH4_F), 0, FCH4_F*60*(1/1000000000)*12*30))


## Summation of data
net_CO2 <- sum(df_y2$FC_F_no_NAs)
net_CH4 <- sum(df_y2$FCH4_F_no_NAs) 


## Marco uses g CH4 not g C, gets a value of ~11 for CH4 in 2023

# Used IPCC Sixth Assessment Report (AR6) global warming potentials, 100 year time period - could use paper gwp* or delta equation for future analysis

net_CH4_CO2e <- net_CH4*27.2
sum = net_CO2+net_CH4


#Dataframe created to generate bar graph
net_wp <- data.frame(
  Category = c("Total", "CO2", "CH4"),
  Value = c( round(sum, 2), round(net_CO2, 2), round(net_CH4, 2) 
))

#Plot here

ggplot(net_wp, aes(y = Category, x = Value)) +
  theme_bw()+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  geom_vline(xintercept=0, colour = "black")+
  labs(
    y = c(expression ("Total"), expression("CO"[2]), expression("CH"[4])),
    x = expression("Net Carbon Flux (g C"~m^-2~y^-1*")"),
    title = "Year 2: Sept 15th, 2023 to Sept 15th, 2024") +
  geom_label(aes(label = Value), hjust = ifelse(net_wp$Value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_x_continuous(limits=c(-25, 13))


```

# Definition of Seasons

Plots ratio of par in/out, soil heat flux data, snow depth, air temp to identify seasonal trends

```{r}

ggplot(data = df_avg_2023) +
  theme_bw() +
  #geom_line(aes(x = DOY, y = TS_1_2_1), color = 'red') +
  geom_line(aes(x = DOY, y = TA), color = 'darkgreen') +
  #geom_line(aes(x = DOY, y = (PPFD_OUT*500) / PPFD_IN), color = 'green') +
  ## Lower values = more green
  #geom_line(aes(x = DOY, y = D_SNOW/2), color = 'purple') +
  geom_line(aes(x = DOY, y = (FC_F*15)), color = 'darkblue') +
  geom_line(aes(x = DOY, y = 0, color = 'black')) +
  scale_y_continuous(name = expression('Biomet Vars & FC'), limits = c(-30,20)) +
  geom_vline(xintercept = 124)+ #end of winter, 05-04-23
  geom_vline(xintercept = 162)+ #end of snowmelt, 06-11-23
  geom_vline(xintercept = 248)+ #end of growing season, 09-05-23
  geom_vline(xintercept = 294)+ #end of Fall Senescence, 10-21-23
  scale_x_continuous(limits = c(0, 366))


ggplot(data = df_avg_2024) +
  theme_bw() +
  #geom_line(aes(x = DOY, y = TS_1_2_1), color = 'red') +
  geom_line(aes(x = DOY, y = TA), color = 'darkgreen') +
  #geom_line(aes(x = DOY, y = (PPFD_OUT*500) / PPFD_IN), color = 'green') +
  ## Lower values = more green
  #geom_line(aes(x = DOY, y = D_SNOW/2), color = 'purple') +
  geom_point(aes(x = DOY, y = (FC_F*15)), color = 'darkblue') +
  geom_line(aes(x = DOY, y = 0, color = 'black')) +
  scale_y_continuous(name = expression('Biomet Vars & FC'), limits = c(-30,20)) +
  geom_vline(xintercept = 135)+ #end of winter, 05-14-24
  geom_vline(xintercept = 169)+ #end of snowmelt, 06-17-24
  geom_vline(xintercept = 256)+ #end of growing season, 09-12-24
  #geom_vline(xintercept = xxx)+ #end of Fall Senescence tbd
  scale_x_continuous(limits = c(0, 300))





####Last days

##  End of fall 1: 10-15-2022; DOY 288

## end of winter 1, 05-04-23
## end of snowmelt 1, 06-11-23
## end of growing season 1, 09-05-23
## end of Fall Senescence 2, 10-21-23

## End of winter 2: 05-14-2024; DOY 135
## End of snowmelt 2: 06-17-2024; DOY 169
## End of growing season 2: 09-12-2024; DOY 256


```



#### Add Seasons to Dataframes

2023
``` {r}

# Definition of seasons in the daily average dataframe 

df_avg_2023 <- df_avg_2023 %>%
  mutate(
      season = case_when(
      (DOY >= 249 & DOY <= 294) ~ 'Fall Senescence',
      (DOY >= 125 & DOY <= 162) ~ 'Snow Melt',
      (DOY >= 163 & DOY <= 248) ~ 'Growing Season',
      (DOY >= 295 | DOY <= 124) ~ 'Winter',
      TRUE ~ NA_character_
    )
  )


# Definition of seasons in the half-hourly dataframe 

df_2023 <- df_2023 %>%
  mutate(
      season = case_when(
      (DOY >= 249 & DOY <= 294) ~ 'Fall Senescence',
      (DOY >= 125 & DOY <= 162) ~ 'Snow Melt',
      (DOY >= 163 & DOY <= 248) ~ 'Growing Season',
      (DOY >= 295 | DOY <= 124) ~ 'Winter',
      TRUE ~ NA_character_
    )
  )

```

2024
``` {r}

# Definition of seasons in the daily average dataframe 

df_avg_2024 <- df_avg_2024 %>%
  mutate(
      season = case_when(
      (DOY >= 257) ~ 'Fall Senescence',
      (DOY >= 136 & DOY <= 169) ~ 'Snow Melt',
      (DOY >= 170 & DOY <= 256) ~ 'Growing Season',
      (DOY <= 135) ~ 'Winter',
      TRUE ~ NA_character_
    )
  )


# Definition of seasons in the half-hourly dataframe 

df_2024 <- df_2024 %>%
  mutate(
      season = case_when(
      (DOY >= 257) ~ 'Fall Senescence',
      (DOY >= 136 & DOY <= 169) ~ 'Snow Melt',
      (DOY >= 170 & DOY <= 256) ~ 'Growing Season',
      (DOY <= 135) ~ 'Winter',
      TRUE ~ NA_character_
    )
  )

```

Full dataset
```{r}
df_avg_23_24 <- df_avg_23_24 %>%
  mutate(
      season = case_when(
      (date <= as.POSIXct("2022-10-15")) ~ 'Fall Senescence 2022',
      (date >= as.POSIXct("2022-10-16") & date <= as.POSIXct("2023-05-04")) ~ 'Winter 2022/2023',
      (date >= as.POSIXct("2023-05-05") & date <= as.POSIXct("2023-06-11")) ~ 'Snow Melt 2023',
      (date >= as.POSIXct("2023-06-12") & date <= as.POSIXct("2023-09-05")) ~ 'Growing Season 2023',
      (date >= as.POSIXct("2023-09-06") & date <= as.POSIXct("2023-10-21")) ~ 'Fall Senescence 2023',
      (date >= as.POSIXct("2023-10-22") & date <= as.POSIXct("2024-05-14")) ~ 'Winter 2023/2024',
      (date >= as.POSIXct("2024-05-15") & date <= as.POSIXct("2024-06-17")) ~ 'Snow Melt 2024',
      (date >= as.POSIXct("2024-06-18") & date <= as.POSIXct("2024-09-12")) ~ 'Growing Season 2024',
      (date >= as.POSIXct("2024-09-13")) ~ 'Fall Senescence 2024',
      TRUE ~ NA_character_
    )
  )


# Definition of seasons in the half-hourly dataframe 

df_23_24 <- df_23_24 %>%
  mutate(
    season = case_when(
      (date <= as.POSIXct("2022-10-15")) ~ 'Fall Senescence 2022',
      (date >= as.POSIXct("2022-10-16") & date <= as.POSIXct("2023-05-04")) ~ 'Winter 2022/2023',
      (date >= as.POSIXct("2023-05-05") & date <= as.POSIXct("2023-06-11")) ~ 'Snow Melt 2023',
      (date >= as.POSIXct("2023-06-12") & date <= as.POSIXct("2023-09-05")) ~ 'Growing Season 2023',
      (date >= as.POSIXct("2023-09-06") & date <= as.POSIXct("2023-10-21")) ~ 'Fall Senescence 2023',
      (date >= as.POSIXct("2023-10-22") & date <= as.POSIXct("2024-05-14")) ~ 'Winter 2023/2024',
      (date >= as.POSIXct("2024-05-15") & date <= as.POSIXct("2024-06-17")) ~ 'Snow Melt 2024',
      (date >= as.POSIXct("2024-06-18") & date <= as.POSIXct("2024-09-12")) ~ 'Growing Season 2024',
      (date >= as.POSIXct("2024-09-13")) ~ 'Fall Senescence 2024',
      TRUE ~ NA_character_
    )
  )

```

#### Split Plots

Plot 5 on Ameriflux poster

Definition of seasons: 3+ days of FC_F>0 for growing season, and 3+ days of air temperature <0 for winter. Gaps are senescence and spring

```{r}



## CO2 Flux and Soil/Air Temp
tempplotco2 <- ggplot(data = df_avg_23_24) +
  theme_bw() +
  geom_hline(yintercept=0, colour = "black")+
  geom_line(aes(x = day, y = TS_2_05_1/15, colour = "5cm Hummock Soil Temperature")) +
  geom_line(aes(x = day, y = TA/15, colour = "Air Temperature")) +
  geom_point(aes(x = day, y = FC_F*60*60*24*(1/1000000)*12, colour = "NEE"))+
  scale_x_datetime(name = expression(""))+
  scale_y_continuous(
  name = expression("NEE (g C"~m^-2~d^-1~")"),
  sec.axis = sec_axis(~ . * 15, name = expression("Temperature ("*degree*"C)"))) +
  scale_color_manual(
    name = "",
    values = c( "NEE" = "turquoise3", "5cm Hummock Soil Temperature" = "darkblue", "Air Temperature" = "salmon"),
  breaks = c("NEE", "5cm Soil Temperature", "Air Temperature"))+
  geom_vline(xintercept =  as.POSIXct("2022-10-15"))+ #end of fall
  geom_vline(xintercept = as.POSIXct("2023-05-05"))+ #end of winter, DOY 125
  geom_vline(xintercept =  as.POSIXct("2023-06-12"))+ #end of snowmelt, DOY 163
  geom_vline(xintercept =  as.POSIXct("2023-09-06"))+ #end of growing season, DOY 249
  geom_vline(xintercept =  as.POSIXct("2023-10-22"))+ #end of fall
  geom_vline(xintercept =  as.POSIXct("2024-05-14"))+ #end of winter
  geom_vline(xintercept =  as.POSIXct("2024-06-17"))+ #end of snowmelt
  geom_vline(xintercept =  as.POSIXct("2024-09-12")) #end of growing season, DOY 249

tempplotco2

```




# Seasonal Correlations

correlation between variables in growing season

```{r}

df_growing_avg_2023 <- filter(df_avg_2023, season == "Growing Season")

cor(df_growing_avg_2023$FC_F, df_growing_avg_2023$TA)


```


# Cumulative Emissions Plot

Shows NEE and Methane flux accumulation of C over the year, with colors representing different seasons

#### NEE

2023
```{r}

# Units start as Micromoles of CO2/(m^2s), converted to g C/m^2


# Creates column in dataframe that is in the correct units, without NAs
df_avg_2023 <- df_avg_2023 %>%
  subset(format(day, "%Y") == "2023") %>%
  mutate(day_as_POSIXct = as.POSIXct(day)) %>%
  mutate(DOY = as.numeric(format(day_as_POSIXct, "%j"))) %>%
  subset(select = -c(day_as_POSIXct)) %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F*60*60*24*(1/1000000)*12)) %>%
  mutate(cumulative = cumtrapz(DOY, FC_F_no_NAs))


# Calculates numeric sum of CO2 Flux in 2023
trapz(df_avg_2023$DOY, df_avg_2023$FC_F_no_NAs)
#returns -12.24842 grams of C/m2



# Plots cumulative CO2 Flux for the year of 2023
ggplot(data = df_avg_2023, aes(x=DOY, y=cumulative, color = season))+
  geom_point()+
  scale_x_continuous(lim = c(0, 365))+
  geom_hline(yintercept=0, col="black")+ 
  scale_y_continuous(expression('Cumulative CO2 Emissions (g C/m^2)'))
  

```


Full
```{r}

# Units start as Micromoles of CO2/(m^2s), converted to g C/m^2


# Creates column in dataframe that is in the correct units, without NAs
df_avg_2024 <- df_avg_2024 %>%
  subset(format(day, "%Y") == "2024") %>%
  mutate(day_as_POSIXct = as.POSIXct(day)) %>%
  mutate(DOY = as.numeric(format(day_as_POSIXct, "%j"))) %>%
  subset(select = -c(day_as_POSIXct)) %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F*60*60*24*(1/1000000)*12)) %>%
  mutate(cumulative = cumtrapz(DOY, FC_F_no_NAs))


# Calculates numeric sum of CO2 Flux in 2023
trapz(df_avg_2024$DOY, df_avg_2024$FC_F_no_NAs)
#returns 134.98



# Plots cumulative CO2 Flux for the year of 2023
ggplot(data = df_avg_2024, aes(x=DOY, y=cumulative, color = season))+
  geom_point()+
  scale_x_continuous(lim = c(0, 365))+
  geom_hline(yintercept=0, col="black")+ 
  scale_y_continuous(expression('Cumulative CO2 Emissions (g C/m^2)'))
  

```

Full
```{r}

# Units start as Micromoles of CO2/(m^2s), converted to g C/m^2


# Creates column in dataframe that is in the correct units, without NAs
df_avg_23_24 <- df_avg_23_24 %>%
  mutate(day_as_POSIXct = as.POSIXct(day)) %>%
  mutate(DOY = as.numeric(format(day_as_POSIXct, "%j"))) %>%
  subset(select = -c(day_as_POSIXct)) %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F*60*60*24*(1/1000000)*12)) %>%
  mutate(cumulative = cumtrapz(DOY, FC_F_no_NAs))


# Calculates numeric sum of CO2 Flux in 2023
trapz(df_avg_23_24$DOY, df_avg_23_24$FC_F_no_NAs)
#returns -12.24842 grams of C/m2



# Plots cumulative CO2 Flux for the year of 2023
ggplot(data = df_avg_23_24, aes(x=DOY, y=cumulative, color = season))+
  geom_point()+
  scale_x_continuous(lim = c(0, 365))+
  geom_hline(yintercept=0, col="black")+ 
  scale_y_continuous(expression('Cumulative CO2 Emissions (g C/m^2)'))
  

```

#### Methane

```{r}

# For unit adjustment: 
#   Units start as micromoles of CH4/(m^2s), converted to Grams of C/m^2

df_avg_2023 <- df_avg_2023 %>%
  subset(format(day, "%Y") == "2023") %>%
  mutate(day_as_POSIXct = as.POSIXct(day)) %>%
  mutate(DOY = as.numeric(format(day_as_POSIXct, "%j"))) %>%
  subset(select = -c(day_as_POSIXct)) %>%
  mutate(FCH4_F_no_NAs = ifelse(is.na(FCH4_F), 0, FCH4_F)) %>%
  mutate(cumulativeCH4 = 
           cumtrapz(DOY, FCH4_F_no_NAs*60*30*(1/1000000)*12))

trapz(df_avg_2023$DOY, df_avg_2023$FCH4_F*60*30*(1/1000000)*12)
#returns 0.1734819

# Also doesn't align with earlier budget

ggplot(data = df_avg_2023, aes(x=DOY, y=cumulativeCH4, color = season))+
  geom_point()+
  scale_x_continuous(lim = c(0, 365))+
  geom_hline(yintercept=0, col="black")+ 
  scale_y_continuous(expression('Cumulative CH4 Emissions (mg of C)'))
  

```

# Seasonal Budgets

Use half-hourly data to calculate net co2 budgets by season Average rate per day

To separate graph for daily rate; use geom_violin

## NEE

Plot 3 in Ameriflux poster

Finds the net CO2 exchange of each season as defined above

```{r}

seasonal_integrals <- function(df) {
  
  # Calculate integral (sum) for each season
  integrals <- df %>%
    group_by(season) %>%
    summarise(integral_value = sum(FC_F, na.rm = TRUE)) %>%
    ungroup() %>%
    arrange(season)
  
  
  # Changes units from  Micromoles of CO2/((m^2)s) to Grams of C/m^2, and rounds
    integrals$integral_value = 
      round(integrals$integral_value*60*30*(1/1000000)*12, 2)
  
  return(integrals)
}

seasonal_integrals_2023 <- seasonal_integrals(df_2023)

#reorders seasons to timeline order
seasonal_integrals_2023$season <- factor(seasonal_integrals_2023$season, levels = c("Snow Melt", "Growing Season", "Fall Senescence", "Winter"))

ggplot(seasonal_integrals_2023, aes(x = season, y = integral_value)) +
  theme_bw()+
  geom_hline(yintercept=0, colour="black")+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  labs(
    x = " ",
    y = expression("Net CO"[2] * " Flux (g C m"^-2*")"),
    title = expression("Net CO"[2] * " Flux by Season 2023")
  ) +
  geom_label(aes(label = integral_value), vjust = ifelse(seasonal_integrals_2023$integral_value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(-53, 23))
 


#2024
seasonal_integrals_2024 <- seasonal_integrals(df_2024)

#reorders seasons to timeline order
seasonal_integrals_2024$season <- factor(seasonal_integrals_2024$season, levels = c("Snow Melt", "Growing Season", "Fall Senescence", "Winter"))

ggplot(seasonal_integrals_2024, aes(x = season, y = integral_value)) +
  theme_bw()+
  geom_hline(yintercept=0, colour="black")+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  labs(
    x = " ",
    y = expression("Net CO"[2] * " Flux (g C m"^-2*")"),
    title = expression("Net CO"[2] * " Flux by Season 2024")
  ) +
  geom_label(aes(label = integral_value), vjust = ifelse(seasonal_integrals_2024$integral_value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(-53, 23))

# Full set

seasonal_integrals_full <- seasonal_integrals(df_23_24)

seasonal_integrals_full$season <- factor(seasonal_integrals_full$season, levels = c("Fall Senescence 2022", "Winter 2022/2023", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2023/2024", "Snow Melt 2024", "Growing Season 2024", "Fall Senescence 2024"))

#Filter to remove incomplete fall seasons
filtered_data <- seasonal_integrals_full %>%
  filter(season %in% c("Winter 2022/2023", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2023/2024", "Snow Melt 2024", "Growing Season 2024"))
         
         
ggplot(filtered_data, aes(x = season, y = integral_value)) +
  theme_bw()+
  geom_hline(yintercept=0, colour="black")+geom_hline(yintercept=0, colour="black")+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  labs(
    x = " ",
    y = expression("Net CO"[2] * " Flux (g C m"^-2*")"),
    title = expression("Net CO"[2] * " Flux by Season")
  ) +
  geom_label(aes(label = integral_value), vjust = ifelse(filtered_data$integral_value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(-58, 23)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
 

# Bar graph showing growing season vs. year round analysis
# Change GPP to negative to show dynamics in budget




```

## GPP

Finds the net GPP of each season

```{r}

seasonal_integrals <- function(df) {
  
  # Calculate integral (sum) for each season
  integrals <- df %>%
    group_by(season) %>% 
    summarise(integral_value = sum(GPP_F, na.rm = TRUE)) %>%
    ungroup() %>%
    arrange(season)
  
    
# Changes units from  Micromoles of CO2/(m^2s) to Grams of C/m^2, makes GPP a negative value, and rounds
  
    integrals$integral_value = 
      round(integrals$integral_value*-60*30*(1/1000000)*12, 2)
  
  return(integrals)
}

seasonal_integrals_2023 <- seasonal_integrals(df_2023)

ggplot(seasonal_integrals_2023, aes(x = season, y = integral_value)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Season",
    y = "Net GPP (Grams of Carbon/m^2)",
    title = "2023 GPP by season"
  ) +
  theme_minimal()+
  geom_text(aes(label = integral_value), vjust = 1, colour = "orange")


```

## RECO

```{r}

seasonal_integrals <- function(df) {
  
  # Calculate integral (sum) for each season
  integrals <- df %>%
    group_by(season) %>%
    summarise(integral_value = sum(RECO, na.rm = TRUE)) %>%
    ungroup() %>%
    arrange(season)
  
    
  # Changes units from  Micromoles of CO2/(m^2s) to Grams of C/m^2, and rounds
    integrals$integral_value = 
      round(integrals$integral_value*60*30*(1/1000000)*12, 2)
  
  return(integrals)
}

seasonal_integrals_2023 <- seasonal_integrals(df_2023)

ggplot(seasonal_integrals_2023, aes(x = season, y = integral_value)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    x = "Season",
    y = "Net ER (Grams of Carbon/m^2)",
    title = "2023 Ecosystem Respiration by season"
  ) +
  theme_minimal()+
  geom_text(aes(label = integral_value), vjust = 1, colour = "orange")



# Bar graph showing growing season vs. year round analysis



```

## Methane

Plot 4 on Ameriflux Poster


```{r}

seasonal_integrals <- function(df) {
  
  # Calculate integral (sum) for each season
  integrals <- df %>%
    group_by(season) %>%
    summarise(integral_value = sum(FCH4_F, na.rm = TRUE)) %>%
    ungroup() %>%
    arrange(season)
  
    
  # Changes units from mmol of CH4/(m^2s) to grams of C/m^2, and rounds
    integrals$integral_value = 
      round(integrals$integral_value*60*30*(1/1000000000)*12, 2)
  
  return(integrals)
}

seasonal_integrals_2023 <- seasonal_integrals(df_2023)

#reorders seasons to timeline order
seasonal_integrals_2023$season <- factor(seasonal_integrals_2023$season, levels = c("Snow Melt", "Growing Season", "Fall Senescence", "Winter"))

ggplot(seasonal_integrals_2023, aes(x = season, y = integral_value)) +
  theme_bw()+
  geom_hline(yintercept=0, colour="black")+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  labs(
    x = "",
    y = expression("Net CH"[4] * " Flux (g C m"^-2*")"),
    title = expression("Net CH"[4] * " Flux by Season")
  ) +
  geom_label(aes(label = integral_value), vjust = ifelse(seasonal_integrals_2023$integral_value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(0, 6.1))



seasonal_integrals_full <- seasonal_integrals(df_23_24)

seasonal_integrals_full$season <- factor(seasonal_integrals_full$season, levels = c("Fall Senescence 2022", "Winter 2022/2023", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2023/2024", "Snow Melt 2024", "Growing Season 2024", "Fall Senescence 2024"))

#Filter to remove incomplete fall seasons
filtered_data_ch4 <- seasonal_integrals_full %>%
  filter(season %in% c("Winter 2022/2023", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2023/2024", "Snow Melt 2024", "Growing Season 2024"))
         
         
ggplot(filtered_data_ch4, aes(x = season, y = integral_value)) +
  theme_bw()+
  geom_hline(yintercept=0, colour="black")+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  labs(
    x = "",
    y = expression("Net CH"[4] * " Flux (g C m"^-2*")"),
    title = expression("Net CH"[4] * " Flux by Season")
  ) +
  geom_label(aes(label = integral_value), vjust = ifelse(filtered_data_ch4$integral_value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(0, 6.2))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
 

```

# Season Average Table
```{r}

df_avg_biomet <- df_23_24 %>%
  group_by(season) %>%
  summarize(
    nee = round(mean(FC* 60 * (1/1000000) * 12 * 30 * 48, na.rm = TRUE), 3),
    tair = round(mean(TA, na.rm = TRUE), 2),
    tsoil5 = round(mean(TS_2_05_1, na.rm = TRUE), 2),
    swc = round(mean(SWC_1_1_1, na.rm = TRUE), 2)
    ) %>%
    arrange(factor(season, levels = c("Fall Senescence 2022", "Winter 2022/2023", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2023/2024", "Snow Melt 2024", "Growing Season 2024", "Fall Senescence 2024")))




season_counts <- 
  df_avg_23_24 %>%
  filter(season %in% c("Fall Senescence 2022", "Winter 2022/2023", 
                       "Snow Melt 2023", "Growing Season 2023", 
                       "Fall Senescence 2023", "Winter 2023/2024", 
                       "Snow Melt 2024", "Growing Season 2024", 
                       "Fall Senescence 2024")) %>%
  count(season)


df_avg_biomet <- right_join(df_avg_biomet, season_counts, by = "season") 



gt(df_avg_biomet,
   rowname_col = "season") %>% 
  tab_header(title = "Seasonal Averages",
             subtitle = "Sept. 15th, 2022 to Sept 15th, 2024") %>%
  cols_label(
    tair = md("Air Temp<br><span style='font-size:10pt'>(&deg;C)</span>"),
    tsoil5 = md("5cm Soil Temp<br><span style='font-size:10pt'>(&deg;C)</span>"),
    swc = md("SWC<br><span style='font-size:10pt'>(m<sup>3</sup>m<sup>-3</sup>)</span>"),
    nee = md("NEE<br><span style='font-size:10pt'>(gCm<sup>-2</sup>d<sup>-1</sup>)</span>"),
    n = md("Length<br><span style='font-size:10pt'>(days)</span>")
  )%>%
  cols_width(
    stub() ~ px(160)
  )%>%
  tab_style(
    style = cell_text(align = "center"),
    locations = list(
      cells_body(),    # Center all data cells
      cells_column_labels() # Center all column labels
    )
  )
  

```

# Snowmelt peak analysis

```{r}

## Shows non-temperature correlated peak in CO2 Flux data during snowmelt

## Very useful paper on this: https://doi.org/10.1002/2016GL071220


## May 15: DOY 135


ggplot(data = df_avg_23_24) +
  theme_bw() +
  #geom_point(aes(x = day, y = FC), color = 'black') +
  geom_point(aes(x = day, y = FC_night, color = 'Nighttime NEE')) +
  # geom_point(aes(x = day, y = GPP_F), color = 'green') +
  # geom_point(aes(x = day, y = FCH4/30), color = 'orange') +
  # geom_point(aes(x = day, y = RECO), color = 'purple') +
  geom_line(aes(x = day, y = TS_2_05_1/10, color = '5cm Soil Temperature')) + 
  geom_line(aes(x= day, y= TA/10, color="Air Temperature"))+
  #geom_point(aes(x=day, y = G_1_1_1*(1/50)), color = "grey")+
  #geom_line(aes(x = day, y = SWC_2_1_1/30), color = 'red') +
  #geom_line(aes(x = day, y = D_SNOW/20), color = 'darkgreen') +
  geom_hline(yintercept = 0) +
  ggtitle("Spring 2024")+
  scale_y_continuous(
    name = expression('Nighttime NEE'),
    limits = c(-2, 3.5),
    sec.axis = sec_axis(~.*10, name = expression("Temperature ("*degree*"C)"))
    ) +
  scale_x_datetime(limits = as.POSIXct(c('2024-04-01', '2024-06-30')), name = "")+
  scale_color_manual(name = " ",
            values = c("Nighttime NEE" = "turquoise3",
                      "5cm Soil Temperature" = "navy",
                      "Air Temperature" = "salmon"),
            breaks = c("Nighttime NEE", "5cm Soil Temperature", "Air Temperature"))

```

# Soil temp heat map (in progress)

## Create dataframe

```{r}

# Create new data frame for plot; one column is timestamp, one is soil temp depth, and one is numeric temperature value; 12 soil depths over two profiles in data set

#Creates numeric vector of the correct length with all of the soil temperature measurement depths in cm, repeated once for each row of data collected

# # To view all soil temperature variables in dataset
# print(grep("^TS_1", names(df), value = TRUE))

#Uses depth values in cm for easy coercion to numeric later
ts_columns <- rep(c("0", "10", "20", "30", "40", "50", "60", "70", "80", "90", "100"), nrow(df_23_24))

#Picks columns to move into new dataframe; 5 cm lost to make geom_raster work, could linearly interpolate or use geom_tile later?
df_soiltemp = select(df_23_24, TIMESTAMP, grep("^TS_1", names(df), value = TRUE), -TS_1_05_1) 

#Changes column names to line up with numeric depth values
colnames(df_soiltemp) = c("Time", "10", "0", "20", "30", "40", "50", "60", "70", "80", "90", "100")

# Uses linear interpolation to fill NAs in data to create smooth plot
for (col in c("10", "0", "20", "30", "40", "50", "60", "70", "80", "90", "100")) {
  df_soiltemp[[col]] <- na.approx(df_soiltemp[[col]])
}

#repeats every row of the dataframe 11 times
df_soiltemp <- df_soiltemp %>%
  slice(rep(1:n(), each = 11)) %>%
  bind_cols(ts_columns)

names(df_soiltemp)[13] <- "Depth"

#creates empty temp variable to fill with temp values
df_soiltemp$Temperature = NA


#Move corresponding temperature values into the temperature column, them remove unneccesary columns
df_soiltemp <- df_soiltemp %>%
  rowwise() %>%
  mutate(Temperature = ifelse(Depth %in% colnames(df_soiltemp), get(Depth), NA)) %>%
  ungroup() %>%
  select(-c("10", "0", "20", "30", "40", "50", "60", "70", "80", "90", "100"))

df_soiltemp$Depth = as.numeric(df_soiltemp$Depth)

summary(df_soiltemp)

```

## Create Plot 

```{r}
pal = c('red','orange','yellow','cyan','lightblue','blue','purple','violet')
pal = c('violet','violet','purple','blue','lightblue','cyan','green','yellow','orange','red','red')


soiltemp <- ggplot()+
  theme_bw()+
  geom_raster(data = df_soiltemp, interpolate = TRUE)+
  aes(x=Time, y=-Depth, fill= Temperature)+
#  scale_fill_viridis_c()+
  scale_fill_gradient2(low = c('pink','violet','purple','blue'),mid = 'cyan',high = c('green','yellow','orange','red'),midpoint = 0,limits = c(-15,20),oob = scales::squish)+
  # scale_fill_gradientn('Temp.',
  #                      na.value = 'transparent',
  #                      colours = pal, # 
  #                      #trans = 'log',
  #                      limits = c(-15,20),
  #                   #   labels = c("Good","Poor"),
  #                     # breaks = c(0,3.5),
  #                      oob = scales::squish)+ #out of bounds, squishes everything into scale 
  # add manual color scale, 0 is tight cyan color, cool negative colors and warm positive colors
  scale_y_continuous(name = "Depth (cm)",
    # trans = "reverse",  # Reverses the direction of the axis
    breaks = seq(0, -100, by = -10),  # Sets breaks for each 10 cm
    labels = seq(0, 100, by = 10) )
#+
  scale_x_datetime(limits = as.POSIXct(c('2024-03-05', '2024-05-30')))

soiltemp

hist(df_soiltemp$Temperature)
#Stop temp scale at 20, make 20+ its own color to help with skew
  

```


#  Temperature Relationship

Plots 6 and 7 for Ameriflux poster

```{r}

#Creates a month variable in the 2023 dataframe

df_2023$month = as.numeric(as.yearmon(df_2023$day))

#Plots flux variables vs. 5cm soil temp to visualize temperature/co2 flux relationship

#RECO vs. soil temp; Not that useful because temperature was used to partition data

ggplot(data=df_2023)+
  geom_point(aes(x=TS_1_05_1, y=RECO, col = day))+
  labs(
    x = "Soil Temp",
    y = "Respiration",
    title = "Respiraton vs. Soil Temp"
  )

## Temp relationship plots with half hourly data

# FC_night vs. soil temp; used to estimate RECO without temp correlation or gap filling

ggplot(data=df_2023)+
  theme_bw()+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_point(aes(x=TS_1_05_1, y=FC_night, col = DOY))+
scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("5cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly nighttime CO"[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Nighttime CO"[2] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits=c(-15,25))+
  scale_y_continuous(limits=c(-0.5,2.5))


#Methane vs. soil temp

ggplot(data=df_2023)+
  geom_vline(xintercept=0)+
  theme_bw()+
  geom_point(aes(x=TS_1_05_1, y=FCH4*(1/1000), col = DOY))+
scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("5cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("CH"[4] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits = c(-15, 30))+
  scale_y_continuous(limits = c(-0.04, .150))


ggplot(data=df_2024)+
  geom_vline(xintercept=0)+
  theme_bw()+
  geom_point(aes(x=TS_1_05_1, y=FCH4*(1/1000), col = DOY))+
scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("5cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("CH"[4] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits = c(-15, 30))+
  scale_y_continuous(limits = c(-0.04, .150))


ggplot(data=df_avg_2024)+
  theme_bw()+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_point(aes(x=TS_1_05_1, y=FC_night, col = DOY))+
scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("5cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly nighttime CO"[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Nighttime CO"[2] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits=c(-15,25))+
  scale_y_continuous(limits=c(-0.5,2.5))







## Temp relationship plots with daily avg data

# FC_night vs. soil temp; used to estimate RECO without temp correlation or gap filling

ggplot(data=df_avg_2023)+
  theme_bw()+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_point(aes(x=TS_1_05_1, y=FC_night, col = DOY))+
scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("5cm Soil Temperature ("*degree*"C)"),
    y = expression("Daily Average nighttime CO"[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Nighttime CO"[2] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits=c(-15,18))+
  scale_y_continuous(limits=c(-0.5,2.1))


#Methane vs. soil temp

ggplot(data=df_avg_2023)+
  geom_vline(xintercept=0)+
  theme_bw()+
  geom_point(aes(x=TS_1_05_1, y=FCH4*(1/1000), col = DOY))+
scale_color_gradient(low = "navy", high = "salmon")+
  labs(
    x = expression("5cm Soil Temperature ("*degree*"C)"),
    y = expression("Daily Average CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("CH"[4] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits = c(-15, 20))+
  scale_y_continuous(limits = c(-0.03, .10))


```



#### Exponential - doesn't work yet

Daily average values are less noisy, better for analysis
```{r}

ta_fc <- lm(log10(RECO) ~ TS_1_05_1, data = df_avg_2023)
  
ta_fc$residuals
ta_fc$rank
ta_fc$df.residual

anova(ta_fc)
summary(ta_fc)

plot(ta_fc)



plot(df_avg_2023$TS_1_05_1, log10(df_avg_2023$RECO))
abline(ta_fc)

#skewed residuals: model isn't working well
hist(ta_fc$residuals)

#   ggplot(data=data)+
#   theme_bw()+
#   geom_hline(yintercept = 0)+
#   geom_vline(xintercept = 0)+
#   geom_line(aes_string(y = fit), x=x_var, color = "black") +
#   geom_point(aes(x=x_var, y=y_var, col = DOY))+
# scale_color_gradient(low = "navy", high = "salmon")
# 
# 
# 
# ggplot(data=df_2023)+
#   theme_bw()+
#   geom_hline(yintercept = 0)+
#   geom_vline(xintercept = 0)+
#   geom_line(aes_string(y = fit), x=TS_1_05_1, color = "black") +
#   geom_point(aes(x=TS_1_05_1, y=FC_night, col = DOY))+
# scale_color_gradient(low = "navy", high = "salmon")+
#   labs(
#     x = expression("5cm Soil Temperature ("*degree*"C)"),
#     y = expression("Half-hourly Nighttime CO"[2] * " Flux"),
#     title = expression("Nighttime CO"[2] * " Flux vs. Soil Temperature")
#   )+
#   scale_x_continuous(limits=c(-15,18))+
#   scale_y_continuous(limits=c(-0.5,4))

```



```{r}

ggplot(data = df_23_24)+
  geom_point(aes(x = TIMESTAMP, y = FCH4, color = WD))+
  scale_x_datetime(limits = as.POSIXct(c('2024-05-22','2024-06-01')))
  
ggplot(data = df_23_24)+
  geom_point(aes(x = TIMESTAMP, y = FCH4, color = WD))+
  scale_x_datetime(limits = as.POSIXct(c('2023-05-08','2023-05-16')))


```