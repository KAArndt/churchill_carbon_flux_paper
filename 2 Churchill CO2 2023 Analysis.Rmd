---
title: "Churchill CO2 Data Analysis"
author: "Dani Trangmoe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# add root directory here for github
```

Notes:

```{r, include=FALSE}
rm(list = ls())
Sys.setenv(TZ = "UTC")

library(data.table)
library(ggplot2)
library(cowplot)
library(openair)
library(plotrix) # standard error function
library(signal)
library(svMisc)
library(zoo)
library(stringr)
library(plyr)
library(viridis)
library(lubridate)
library(tidyverse)
library(gridExtra) 
library(plotly)
library(RColorBrewer)
library(pracma)
library(cowplot)
library(nlme)
library(gt)
```

# Load data

```{r}

df = fread('C:/Users/dtrangmoe/Documents/Churchill/Data/Churchill_Merged_CF1_CF3_HH_24.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))

#needs continuous day variable
df_avg = fread('C:/Users/dtrangmoe/Documents/Churchill/Data/Churchill_Merged_Avg_CF1_CF3_HH_24.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))


```

#### Create yearly dataframes, timestamp

```{r}

#Creates data frames of each year containing the daily averages of each value- useful for focusing on one year at a time

df_avg$day <- as.POSIXct(df_avg$date, format = "%Y-%m-%d")
df$day <- as.POSIXct(df$date, format = "%Y-%m-%d")

df$DOY <- yday(df$TIMESTAMP)
df_avg$DOY <- yday(df_avg$TIMESTAMP)


#2023
df_2023 <- df %>%
  filter(year(date) == 2023)
df_avg_2023 <- df_avg %>%
  filter(year(date) == 2023)

#2024

df_2024 <- df %>%
  filter(year(date) == 2024)
df_avg_2024 <- df_avg %>%
  filter(year(date) == 2024)


# #Both (both years fo data, ending at the end of fall senescence 2024. makes two full seasonal cycles of data)

df_avg_23_24 <- subset(df_avg, ((df_avg$TIMESTAMP > as.POSIXct("2022-10-16 00:00")) & (df_avg$TIMESTAMP < as.POSIXct("2024-10-19 00:00"))))
# 
df_23_24 <- subset(df, ((df$TIMESTAMP > as.POSIXct("2022-10-16 00:00")) & (df$TIMESTAMP < as.POSIXct("2024-10-19 00:00"))))




```

#### Add Seasons to Dataframes

2023
``` {r}

# Definition of seasons in the daily average dataframe 

df_avg_2023 <- df_avg_2023 %>%
  mutate(
      season = case_when(
      (DOY >= 249 & DOY <= 294) ~ 'Fall Senescence',
      (DOY >= 125 & DOY <= 162) ~ 'Snow Melt',
      (DOY >= 163 & DOY <= 248) ~ 'Growing Season',
      (DOY >= 295 | DOY <= 124) ~ 'Winter',
      TRUE ~ NA_character_
    )
  )


# Definition of seasons in the half-hourly dataframe 

df_2023 <- df_2023 %>%
  mutate(
      season = case_when(
      (DOY >= 249 & DOY <= 294) ~ 'Fall Senescence',
      (DOY >= 125 & DOY <= 162) ~ 'Snow Melt',
      (DOY >= 163 & DOY <= 248) ~ 'Growing Season',
      (DOY >= 295 | DOY <= 124) ~ 'Winter',
      TRUE ~ NA_character_
    )
  )

```

2024
``` {r}

# Definition of seasons in the daily average dataframe 

df_avg_2024 <- df_avg_2024 %>%
  mutate(
      season = case_when(
      (DOY >= 257 & DOY <= 293) ~ 'Fall Senescence',
      (DOY >= 136 & DOY <= 169) ~ 'Snow Melt',
      (DOY >= 170 & DOY <= 256) ~ 'Growing Season',
      (DOY >= 294 | DOY <= 135) ~ 'Winter',
      TRUE ~ NA_character_
    )
  )


# Definition of seasons in the half-hourly dataframe 

df_2024 <- df_2024 %>%
  mutate(
      season = case_when(
      (DOY >= 257 & DOY <= 293) ~ 'Fall Senescence',
      (DOY >= 136 & DOY <= 169) ~ 'Snow Melt',
      (DOY >= 170 & DOY <= 256) ~ 'Growing Season',
      (DOY >= 294 | DOY <= 135) ~ 'Winter',
      TRUE ~ NA_character_
    )
  )

```

Full dataset
```{r}

df_avg_23_24 <- df_avg_23_24 %>%
  mutate(
      season = case_when(
      (date <= as.POSIXct("2022-10-15")) ~ 'Fall Senescence 2022',
      
      (date >= as.POSIXct("2022-10-16") & date <= as.POSIXct("2023-05-04")) ~ 'Winter 2023',
      
      (date >= as.POSIXct("2023-05-05") & date <= as.POSIXct("2023-06-11")) ~ 'Snow Melt 2023',
      
      (date >= as.POSIXct("2023-06-12") & date <= as.POSIXct("2023-09-05")) ~ 'Growing Season 2023',
      
      (date >= as.POSIXct("2023-09-06") & date <= as.POSIXct("2023-10-21")) ~ 'Fall Senescence 2023',
      
      (date >= as.POSIXct("2023-10-22") & date <= as.POSIXct("2024-05-14")) ~ 'Winter 2024',
      
      (date >= as.POSIXct("2024-05-15") & date <= as.POSIXct("2024-06-17")) ~ 'Snow Melt 2024',
      
      (date >= as.POSIXct("2024-06-18") & date <= as.POSIXct("2024-09-12")) ~ 'Growing Season 2024',
      
      (date >= as.POSIXct("2024-09-13") & date <= as.POSIXct("2024-10-19")) ~ 'Fall Senescence 2024',
      
      (date >= as.POSIXct("2023-10-20")) ~ 'Winter 2025',
      TRUE ~ NA_character_
    )
  )


# Definition of seasons in the half-hourly dataframe 

df_23_24 <- df_23_24 %>%
  mutate(
    season = case_when(
      (date <= as.POSIXct("2022-10-15")) ~ 'Fall Senescence 2022',
      
      (date >= as.POSIXct("2022-10-16") & date <= as.POSIXct("2023-05-04")) ~ 'Winter 2023',
      
      (date >= as.POSIXct("2023-05-05") & date <= as.POSIXct("2023-06-11")) ~ 'Snow Melt 2023',
      
      (date >= as.POSIXct("2023-06-12") & date <= as.POSIXct("2023-09-05")) ~ 'Growing Season 2023',
      
      (date >= as.POSIXct("2023-09-06") & date <= as.POSIXct("2023-10-21")) ~ 'Fall Senescence 2023',
      
      (date >= as.POSIXct("2023-10-22") & date <= as.POSIXct("2024-05-14")) ~ 'Winter 2024',
      
      (date >= as.POSIXct("2024-05-15") & date <= as.POSIXct("2024-06-17")) ~ 'Snow Melt 2024',
      
      (date >= as.POSIXct("2024-06-18") & date <= as.POSIXct("2024-09-12")) ~ 'Growing Season 2024',
      
      (date >= as.POSIXct("2024-09-13") & date <= as.POSIXct("2024-10-19")) ~ 'Fall Senescence 2024',
      
      (date >= as.POSIXct("2023-10-20")) ~ 'Winter 2025',
      TRUE ~ NA_character_
    )
  )


#splits season names into name and year cols
df_avg_23_24 <- df_avg_23_24 %>%
  mutate(
    season_name = str_extract(season, "^[^0-9]+"), # Extract the season name
    year = str_extract(season, "\\d{4}")          # Extract the 4-digit year
  )


#splits season names into name and year cols
df_23_24 <- df_23_24 %>%
  mutate(
    season_name = str_extract(season, "^[^0-9]+"), # Extract the season name
    year = str_extract(season, "\\d{4}")          # Extract the 4-digit year
  )

## For two year budget, broken up at end of fall y1

df_y1 <- subset(df_23_24, ((df_23_24$TIMESTAMP > as.POSIXct("2022-10-16 00:00")) & (df_23_24$TIMESTAMP < as.POSIXct("2023-10-20 00:00"))))

df_avg_y1 <- subset(df_avg_23_24, ((df_avg_23_24$date > as.POSIXct("2022-10-16")) & (df_avg_23_24$date < as.POSIXct("2023-10-20"))))



df_y2 <- subset(df_23_24, ((df_23_24$TIMESTAMP >= as.POSIXct("2023-10-20 00:00")) & (df_23_24$TIMESTAMP < as.POSIXct("2024-10-19 00:00"))))

df_avg_y2 <- subset(df_avg_23_24, ((df_avg_23_24$date >= as.POSIXct("2023-10-20")) & (df_avg_23_24$date < as.POSIXct("2024-10-19"))))
```

### Timeseries plot


Plot 1 on ameriflux poster; timeseries of GPP, ER, NEE, and CH4

```{r}



ggplot(data = df_23_24, aes(x=TIMESTAMP))+
  theme_bw()+
  #geom_point(aes(y = -GPP_F*60*60*24*(1/1000000)*12, color = "GPP"))+
  #geom_point(aes(y = RECO*60*60*24*(1/1000000)*12, color = "Respiration")) +
  geom_point(aes(y = FC_F*60*60*24*(1/1000000)*12, color = "Carbon Flux"))+
  geom_point(aes(y = FCH4_F*60*60*24*(1/1000000000)*12*13, color = "Methane Flux"))+
  geom_hline(yintercept=0, col="black")+
  scale_y_continuous(limits = c(-5, 5), expression('CO'[2]*' Flux (g C'~m^-2~d^-1*')'),
  sec.axis = sec_axis(~ . /13, name = expression('CH'[4]*' Flux (g C'~m^-2~d^-1*')')))+
  scale_color_manual(name = " ",
            values = c(#"GPP" = "navy", 
                      #"Respiration" = "turquoise3", 
                      "Carbon Flux" = "salmon", 
                      "Methane Flux" = "mediumorchid"),
            breaks = c(#"GPP", "Respiration", 
              "Carbon Flux", "Methane Flux"))+
  #scale_x_datetime(limits = as.POSIXct(c('2022-09-15', '2024-09-15')))+
  scale_x_datetime(limits = as.POSIXct(c('2022-10-16', '2024-10-19')))

```



#### Gap Filling Plot

Shows gap in flux data and compares gap filled and non-gap filled data

```{r}

#Uses Half-Hourly data


ggplot(data = df_2024)+
  geom_hline(yintercept = 0)+
  geom_point(aes(TIMESTAMP,FC_F,col='Gapfilled'))+
  geom_point(aes(TIMESTAMP,FC,col='Original'))+
  scale_y_continuous(limits=c(-7,6))+
  scale_x_datetime(limits = as.POSIXct(c('2024-01-01','2024-12-01'),format="%F"))+
  labs(y = "CO2 Flux ", x = "Time") +
  scale_color_manual(values=c('red','black'))+
  geom_vline(xintercept = as.POSIXct("2024-07-05"))


```


#### Net C Budget

Plot 2 in Ameriflux poster

_no_NAs is used for other years of data where NAs are present in gapfilled data

Y1
```{r}

# Units start as micromoles of CO2/(m^2s), converted to Grams of C/m^2

# Net CO2 Flux
df_y1 <- df_y1 %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F * 60 * (1/1000000) * 12 * 30))


# Units start as nanomoles of CH4/(m^2s), converted to Grams of C/m^2

#Net CH4 Flux
df_y1 <- df_y1 %>%
  mutate(FCH4_F_no_NAs = ifelse(is.na(FCH4_F), 0, FCH4_F*60*(1/1000000000)*12*30))


## Summation of data
net_CO2 <- sum(df_y1$FC_F_no_NAs)
net_CH4 <- sum(df_y1$FCH4_F_no_NAs) 


## Marco uses g CH4 not g C, gets a value of ~11 for CH4 in 2023

# Used IPCC Sixth Assessment Report (AR6) global warming potentials, 100 year time period - could use paper gwp* or delta equation for future analysis

net_CH4_CO2e <- net_CH4*27.2
sum = net_CO2+net_CH4


#Dataframe created to generate bar graph
net_wp <- data.frame(
  Category = c("Total", "CO2", "CH4"),
  Value = c(round(sum, 2), round(net_CO2, 2), round(net_CH4, 2) 
))

#Plot here

year1 <- ggplot(net_wp, aes(y = Category, x = Value)) +
  theme_bw()+
  theme(axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 14), 
  axis.title = element_text(size = 16),title = element_text(size = 16), legend.position = 'none')+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  geom_vline(xintercept=0, colour = "black")+
  labs(
    y = "",
    x = expression("Net Carbon Flux (g C"~m^-2~y^-1*")"),
    title = "Year 1") +
  geom_label(aes(label = Value), hjust = ifelse(net_wp$Value >= 0, -0.3, 1.1), colour = "black", fill ="white", size = 5)+
  scale_x_continuous(limits=c(-21, 12))
year1

# png(filename = './year1.png',width = 6.25,height = 4,units = 'in',res = 2000)
# year1
# dev.off()


```


Y2
```{r}

# Units start as micromoles of CO2/(m^2s), converted to Grams of C/m^2

# Net CO2 Flux
df_y2 <- df_y2 %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F * 60 * (1/1000000) * 12 * 30))


# Units start as nanomoles of CH4/(m^2s), converted to Grams of C/m^2

#Net CH4 Flux
df_y2 <- df_y2 %>%
  mutate(FCH4_F_no_NAs = ifelse(is.na(FCH4_F), 0, FCH4_F*60*(1/1000000000)*12*30))


## Summation of data
net_CO2 <- sum(df_y2$FC_F_no_NAs)
net_CH4 <- sum(df_y2$FCH4_F_no_NAs) 


## Marco uses g CH4 not g C, gets a value of ~11 for CH4 in 2023

# Used IPCC Sixth Assessment Report (AR6) global warming potentials, 100 year time period - could use paper gwp* or delta equation for future analysis

net_CH4_CO2e <- net_CH4*27.2
sum = net_CO2+net_CH4


#Dataframe created to generate bar graph
net_wp <- data.frame(
  Category = c("Total", "CO2", "CH4"),
  Value = c( round(sum, 2), round(net_CO2, 2), round(net_CH4, 2) 
))

#Plot here

year2 <- ggplot(net_wp, aes(y = Category, x = Value)) +
  theme_bw()+
  theme(axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 14), 
  axis.title = element_text(size = 16),title = element_text(size = 16), legend.position = 'none')+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  geom_vline(xintercept=0, colour = "black")+
  labs(
    y = c(expression (""), expression("CO"[2]), expression("CH"[4])),
    x = expression("Net Carbon Flux (g C"~m^-2~y^-1*")"),
    title = "Year 2") +
  geom_label(aes(label = Value), hjust = ifelse(net_wp$Value >= 0, -0.3, 1.1), colour = "black", fill ="white", size = 5)+
  scale_x_continuous(limits=c(-36, 12))
year2

# pngfilename = './year2.png',width = 6.25,height = 4,units = 'in',res = 2000)
# year2
# dev.off()


```

# Definition of Seasons

Plots ratio of par in/out, soil heat flux data, snow depth, air temp to identify seasonal trends

```{r}



ggplot(data = df_avg_23_24) +
  theme_bw() +
  #geom_line(aes(x = DOY, y = TS_1_2_1), color = 'red') +
  geom_line(aes(x = DOY, y = TA), color = 'darkgreen') +
  #geom_line(aes(x = DOY, y = (PPFD_OUT*500) / PPFD_IN), color = 'green') +
  ## Lower values = more green
  #geom_line(aes(x = DOY, y = D_SNOW/2), color = 'purple') +
  geom_point(aes(x = DOY, y = (FC_F*15)), color = 'darkblue') +
  geom_line(aes(x = DOY, y = 0, color = 'black')) +
  scale_y_continuous(name = expression('Biomet Vars & FC'), limits = c(-30,20)) +
  geom_vline(xintercept = 135)+ #end of winter, 05-14-24
  geom_vline(xintercept = 169)+ #end of snowmelt, 06-17-24
  geom_vline(xintercept = 256)+ #end of growing season, 09-12-24
  #geom_vline(xintercept = xxx)+ #end of Fall Senescence tbd
  scale_x_continuous(limits = c(0, 365))





####Last days

##  End of fall 1: 10-15-2022; DOY 288

## end of winter 1, 05-04-23
## end of snowmelt 1, 06-11-23
## end of growing season 1, 09-05-23
## end of Fall Senescence 2, 10-21-23

## End of winter 2: 05-14-2024; DOY 135
## End of snowmelt 2: 06-17-2024; DOY 169
## End of growing season 2: 09-12-2024; DOY 256
## End of Fall 3: 10-19-24; DOY 293


```




#### Split Plots

Plot 5 on Ameriflux poster

Definition of seasons: 3+ days of FC_F>0 for growing season, and 3+ days of air temperature <0 for winter. Gaps are senescence and spring

```{r}



## CO2 Flux and Soil/Air Temp
tempplotco2 <- ggplot(data = df_avg_23_24) +
  theme_bw() +
theme(axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 14), 
  axis.title = element_text(size = 16),legend.position = 'none')+
  geom_hline(yintercept=0, colour = "black")+
  geom_line(aes(x = day, y = TS_2_05_1/15, colour = "Soil Temp.")) +
  geom_line(aes(x = day, y = TA/15, colour = "Air Temp.")) +
  geom_point(aes(x = day, y = FC_F*60*60*24*(1/1000000)*12, colour = "NEE"))+
  scale_x_datetime(name = expression(""), 
                   breaks = seq(as.POSIXct("2022-10-01"), as.POSIXct("2024-10-01"), by = "3 months"),
                   date_labels = "%b %Y")+
  scale_y_continuous(
  name = expression("NEE (g CO"[2]*"-C"~m^-2~d^-1~")"),
  sec.axis = sec_axis(~ . * 15, name = expression("Temperature ("*degree*"C)"))) +
  scale_color_manual(
    name = "",
    values = c( "NEE" = "turquoise3", "Soil Temp." = "darkblue", "Air Temp." = "salmon"),
  breaks = c("NEE", "Soil Temp.", "Air Temp."))+
  geom_vline(xintercept =  as.POSIXct("2022-10-15"))+ #end of fall
  geom_vline(xintercept = as.POSIXct("2023-05-05"))+ #end of winter, DOY 125
  geom_vline(xintercept =  as.POSIXct("2023-06-12"))+ #end of snowmelt, DOY 163
  geom_vline(xintercept =  as.POSIXct("2023-09-06"))+ #end of growing season, DOY 249
  geom_vline(xintercept =  as.POSIXct("2023-10-22"), linewidth = 1)+ #end of fall and end of year 1
  geom_vline(xintercept =  as.POSIXct("2024-05-14"))+ #end of winter
  geom_vline(xintercept =  as.POSIXct("2024-06-17"))+ #end of snowmelt
  geom_vline(xintercept =  as.POSIXct("2024-09-12"))+ #end of growing season, DOY 249
  geom_vline(xintercept =  as.POSIXct("2024-10-20"))+ #end of fall
  annotate("text", x = as.POSIXct("2024-07-30"), y = 1.55, label = "Growing\nSeason", size = 3.8)+
  annotate("text", x = as.POSIXct("2023-07-26"), y = 1.55, label = "Growing\nSeason", size = 3.8)+
  annotate("text", x = as.POSIXct("2024-05-31"), y = 1.55, label = "Snow\nMelt", size = 3.8)+
  annotate("text", x = as.POSIXct("2023-05-25"), y = 1.55, label = "Snow\nMelt", size = 3.8)+
  annotate("text", x = as.POSIXct("2023-09-30"), y = 1.55, label = "Fall", size = 3.8)+
  annotate("text", x = as.POSIXct("2024-09-30"), y = 1.55, label = "Fall", size = 3.8)+
  annotate("text", x = as.POSIXct("2024-02-05"), y = 1.55, label = "Winter", size = 3.8)+
  annotate("text", x = as.POSIXct("2023-01-30"), y = 1.55, label = "Winter", size = 3.8)
  
tempplotco2

# png(filename = './seasonal_timeseries.png',width = 11,height = 4.5,units = 'in',res = 2000)
# tempplotco2
# dev.off()
```


# Cumulative Emissions Plot

Shows NEE and Methane flux accumulation of C over the year, with colors representing different seasons

#### NEE

2023
```{r}

# Units start as Micromoles of CO2/(m^2s), converted to g C/m^2


# Creates column in dataframe that is in the correct units, without NAs
df_avg_2023 <- df_avg_2023 %>%
  subset(format(day, "%Y") == "2023") %>%
  mutate(day_as_POSIXct = as.POSIXct(day)) %>%
  mutate(DOY = as.numeric(format(day_as_POSIXct, "%j"))) %>%
  subset(select = -c(day_as_POSIXct)) %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F*60*60*24*(1/1000000)*12)) %>%
  mutate(cumulative = cumtrapz(DOY, FC_F_no_NAs))


# Calculates numeric sum of CO2 Flux in 2023
trapz(df_avg_2023$DOY, df_avg_2023$FC_F_no_NAs)
#returns -12.24842 grams of C/m2



# Plots cumulative CO2 Flux for the year of 2023
ggplot(data = df_avg_2023, aes(x=DOY, y=cumulative, color = season))+
  geom_point()+
  scale_x_continuous(lim = c(0, 365))+
  geom_hline(yintercept=0, col="black")+ 
  scale_y_continuous(expression('Cumulative CO2 Emissions (g C/m^2)'))
  

```


Full
```{r}

# Units start as Micromoles of CO2/(m^2s), converted to g C/m^2

# df_cumsum$day <- as.data.frame(c(1:365))

# 
# # Creates column in dataframe that is in the correct units, without NAs
# df_avg_23_24 <- df_avg_23_24 %>%
#   subset(format(year == "2024")) %>%
#   mutate(day_as_POSIXct = as.POSIXct(day)) %>%
#   mutate(DOY = as.numeric(format(day_as_POSIXct, "%j"))) %>%
#   subset(select = -c(day_as_POSIXct)) %>%
#   mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F*60*60*24*(1/1000000)*12)) %>%
#   mutate(cumulative = cumtrapz(DOY, FC_F_no_NAs))
# 
# 
# # Calculates numeric sum of CO2 Flux in 2023
# trapz(df_avg_2024$DOY, df_avg_2024$FC_F_no_NAs)
# #returns 134.98
# 
# 
# 
# # Plots cumulative CO2 Flux for the year of 2023
# ggplot(data = df_avg_2024, aes(x=DOY, y=cumulative, color = season))+
#   geom_point()+
#   scale_x_continuous(lim = c(0, 365))+
#   geom_hline(yintercept=0, col="black")+ 
#   scale_y_continuous(expression('Cumulative CO2 Emissions (g C/m^2)'))
#   

```

Full
```{r}

# Units start as Micromoles of CO2/(m^2s), converted to g C/m^2


# Creates column in dataframe that is in the correct units, without NAs
df_avg_23_24 <- df_avg_23_24 %>%
  mutate(day_as_POSIXct = as.POSIXct(day)) %>%
  mutate(DOY = as.numeric(format(day_as_POSIXct, "%j"))) %>%
  subset(select = -c(day_as_POSIXct)) %>%
  mutate(FC_F_no_NAs = ifelse(is.na(FC_F), 0, FC_F*60*60*24*(1/1000000)*12)) %>%
  mutate(cumulative = cumtrapz(DOY, FC_F_no_NAs))


# Calculates numeric sum of CO2 Flux in 2023
trapz(df_avg_23_24$DOY, df_avg_23_24$FC_F_no_NAs)
#returns -12.24842 grams of C/m2



# Plots cumulative CO2 Flux for the year of 2023
ggplot(data = df_avg_23_24, aes(x=DOY, y=cumulative, color = season))+
  geom_point()+
  scale_x_continuous(lim = c(0, 365))+
  geom_hline(yintercept=0, col="black")+ 
  scale_y_continuous(expression('Cumulative CO2 Emissions (g C/m^2)'))
  

```

#### Methane

```{r}

# For unit adjustment: 
#   Units start as micromoles of CH4/(m^2s), converted to Grams of C/m^2

df_avg_2023 <- df_avg_2023 %>%
  subset(format(day, "%Y") == "2023") %>%
  mutate(day_as_POSIXct = as.POSIXct(day)) %>%
  mutate(DOY = as.numeric(format(day_as_POSIXct, "%j"))) %>%
  subset(select = -c(day_as_POSIXct)) %>%
  mutate(FCH4_F_no_NAs = ifelse(is.na(FCH4_F), 0, FCH4_F)) %>%
  mutate(cumulativeCH4 = 
           cumtrapz(DOY, FCH4_F_no_NAs*60*30*(1/1000000)*12))

trapz(df_avg_2023$DOY, df_avg_2023$FCH4_F*60*30*(1/1000000)*12)
#returns 0.1734819

# Also doesn't align with earlier budget

ggplot(data = df_avg_2023, aes(x=DOY, y=cumulativeCH4, color = season))+
  geom_point()+
  scale_x_continuous(lim = c(0, 365))+
  geom_hline(yintercept=0, col="black")+ 
  scale_y_continuous(expression('Cumulative CH4 Emissions (mg of C)'))
  

```

# Seasonal Budgets

Use half-hourly data to calculate net co2 budgets by season Average rate per day

To separate graph for daily rate; use geom_violin

## NEE

Plot 3 in Ameriflux poster

Finds the net CO2 exchange of each season as defined above

```{r}

seasonal_integrals <- function(df) {
  
  # Calculate integral (sum) for each season
  integrals <- df %>%
    group_by(season) %>%
    summarise(integral_value = sum(FC_F, na.rm = TRUE)) %>%
    ungroup() %>%
    arrange(season)
  
  
  # Changes units from  Micromoles of CO2/((m^2)s) to Grams of C/m^2, and rounds
    integrals$integral_value = 
      round(integrals$integral_value*60*30*(1/1000000)*12, 2)
  
  return(integrals)
}


# Full set

seasonal_integrals_full <- seasonal_integrals(df_23_24)

seasonal_integrals_full$season <- factor(seasonal_integrals_full$season, levels = c("Fall Senescence 2022", "Winter 2023", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2024", "Snow Melt 2024", "Growing Season 2024", "Fall Senescence 2024"))

#Filter to remove incomplete fall seasons
filtered_data <- seasonal_integrals_full %>%
  filter(season %in% c("Winter 2023", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2024", "Snow Melt 2024", "Growing Season 2024", "Fall Senescence 2024"))
         
         
co2seasons <- ggplot(filtered_data, aes(x = season, y = integral_value)) +
  theme_bw()+
theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 14),legend.position = 'none')+
  geom_hline(yintercept=0, colour="black")+geom_hline(yintercept=0, colour="black")+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  labs(
    x = " ",
    y = expression("Net CO"[2] * " Flux (g C m"^-2*")"),
    title = expression("Net CO"[2] * " Flux by Season")
  ) +
  geom_label(aes(label = integral_value), vjust = ifelse(filtered_data$integral_value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(-65, 23)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))

co2seasons

# png(filename = './co2seasons.png',width = 7.3,height = 4.1,units = 'in',res = 2000)
# co2seasons
# dev.off()
 

# Bar graph showing growing season vs. year round analysis
# Change GPP to negative to show dynamics in budget




```

<!-- ## GPP -->

<!-- Finds the net GPP of each season -->

<!-- ```{r} -->

<!-- seasonal_integrals <- function(df) { -->

<!--   # Calculate integral (sum) for each season -->
<!--   integrals <- df %>% -->
<!--     group_by(season) %>%  -->
<!--     summarise(integral_value = sum(GPP_F, na.rm = TRUE)) %>% -->
<!--     ungroup() %>% -->
<!--     arrange(season) -->


<!-- # Changes units from  Micromoles of CO2/(m^2s) to Grams of C/m^2, makes GPP a negative value, and rounds -->

<!--     integrals$integral_value =  -->
<!--       round(integrals$integral_value*-60*30*(1/1000000)*12, 2) -->

<!--   return(integrals) -->
<!-- } -->

<!-- seasonal_integrals_2023 <- seasonal_integrals(df_2023) -->

<!-- ggplot(seasonal_integrals_2023, aes(x = season, y = integral_value)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs( -->
<!--     x = "Season", -->
<!--     y = "Net GPP (Grams of Carbon/m^2)", -->
<!--     title = "2023 GPP by season" -->
<!--   ) + -->
<!--   theme_minimal()+ -->
<!--   geom_text(aes(label = integral_value), vjust = 1, colour = "orange") -->


<!-- ``` -->

<!-- ## RECO -->

<!-- ```{r} -->

<!-- seasonal_integrals <- function(df) { -->

<!--   # Calculate integral (sum) for each season -->
<!--   integrals <- df %>% -->
<!--     group_by(season) %>% -->
<!--     summarise(integral_value = sum(RECO, na.rm = TRUE)) %>% -->
<!--     ungroup() %>% -->
<!--     arrange(season) -->


<!--   # Changes units from  Micromoles of CO2/(m^2s) to Grams of C/m^2, and rounds -->
<!--     integrals$integral_value =  -->
<!--       round(integrals$integral_value*60*30*(1/1000000)*12, 2) -->

<!--   return(integrals) -->
<!-- } -->

<!-- seasonal_integrals_2023 <- seasonal_integrals(df_2023) -->

<!-- ggplot(seasonal_integrals_2023, aes(x = season, y = integral_value)) + -->
<!--   geom_bar(stat = "identity", position = "dodge") + -->
<!--   labs( -->
<!--     x = "Season", -->
<!--     y = "Net ER (Grams of Carbon/m^2)", -->
<!--     title = "2023 Ecosystem Respiration by season" -->
<!--   ) + -->
<!--   theme_minimal()+ -->
<!--   geom_text(aes(label = integral_value), vjust = 1, colour = "orange") -->



<!-- # Bar graph showing growing season vs. year round analysis -->



<!-- ``` -->

## Methane

Plot 4 on Ameriflux Poster


```{r}

seasonal_integrals <- function(df) {
  
  # Calculate integral (sum) for each season
  integrals <- df %>%
    group_by(season) %>%
    summarise(integral_value = sum(FCH4_F, na.rm = TRUE)) %>%
    ungroup() %>%
    arrange(season)
  
    
  # Changes units from nmol of CH4/(m^2s) to grams of C/m^2, and rounds
    integrals$integral_value = 
      round(integrals$integral_value*60*30*(1/1000000000)*12, 2)
  
  return(integrals)
}

seasonal_integrals_2023 <- seasonal_integrals(df_2023)

#reorders seasons to timeline order
seasonal_integrals_2023$season <- factor(seasonal_integrals_2023$season, levels = c("Snow Melt", "Growing Season", "Fall Senescence", "Winter"))

ch4seasons <- ggplot(seasonal_integrals_2023, aes(x = season, y = integral_value)) +
  theme_bw()+
theme(axis.text.x = element_text(size = 14), axis.text.y = element_text(size = 14), 
  axis.title = element_text(size = 14),legend.position = 'none')+
  geom_hline(yintercept=0, colour="black")+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  labs(
    x = "",
    y = expression("Net CH"[4] * " Flux (g C m"^-2*")"),
    title = expression("Net CH"[4] * " Flux by Season")
  ) +
  geom_label(aes(label = integral_value), vjust = ifelse(seasonal_integrals_2023$integral_value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(0, 6.1))



seasonal_integrals_full <- seasonal_integrals(df_23_24)

seasonal_integrals_full$season <- factor(seasonal_integrals_full$season, levels = c("Fall Senescence 2022", "Winter 2023", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2024", "Snow Melt 2024", "Growing Season 2024", "Fall Senescence 2024"))

#Filter to remove incomplete fall season
filtered_data_ch4 <- seasonal_integrals_full %>%
  filter(season %in% c("Winter 2023", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2024", "Snow Melt 2024", "Growing Season 2024", "Fall Senescence 2024"))
         
         
ch4seasons <- ggplot(filtered_data_ch4, aes(x = season, y = integral_value)) +
  theme_bw()+
theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 14),legend.position = 'none')+
  geom_hline(yintercept=0, colour="black")+
  geom_bar(stat = "identity", position = "dodge", fill = "turquoise3") +
  labs(
    x = "",
    y = expression("Net CH"[4] * " Flux (g C m"^-2*")"),
    title = expression("Net CH"[4] * " Flux by Season")
  ) +
  geom_label(aes(label = integral_value), vjust = ifelse(filtered_data_ch4$integral_value >= 0, -0.7, 1.5), colour = "black", fill ="white")+
  scale_y_continuous(limits=c(0, 6.2), expand = c(0,0))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
ch4seasons

# png(filename = './ch4seasons.png',width = 7.3,height = 4.1,units = 'in',res = 2000)
# ch4seasons
# dev.off()
 

```

# Season Averages


### individual seasons
```{r}


#Averages over each season within each year, and includes no. of days
df_avg_biomet <- df_avg_23_24 %>%
  group_by(season) %>%
  summarize(
    nee = round(mean(FC, na.rm = TRUE), 3),
    tair = round(mean(TA, na.rm = TRUE), 2),
    tsoil5 = round(mean(TS_2_05_1, na.rm = TRUE), 2),
    swc = round(mean(SWC_1_1_1, na.rm = TRUE), 2),
    ws = round(mean(WS, na.rm = TRUE), 2),
    nee.se = round(std.error(FC, na.rm = TRUE), 2),
    tair.se = round(std.error(TA, na.rm = TRUE), 2),
    tsoil5.se = round(std.error(TS_2_05_1, na.rm = TRUE), 2),
    swc.se = round(std.error(SWC_1_1_1, na.rm = TRUE), 2),
    ws.se = round(std.error(WS, na.rm = TRUE), 2)
    ) %>%
  mutate(
    nee_with_se = paste0(nee, " ± ", nee.se),  # Combine value and SE
    tair_with_se = paste0(tair, " ± ", tair.se),
    tsoil5_with_se = paste0(tsoil5, " ± ", tsoil5.se),
  swc_with_se = paste0(swc, " ± ", swc.se),
  ws_with_se = paste0(ws, " ± ", ws.se)
  )%>%
  select(season, nee_with_se, tair_with_se, tsoil5_with_se, swc_with_se, ws_with_se) %>%
    arrange(factor(season, levels = c("Fall Senescence 2022", "Winter 2022", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2023", "Snow Melt 2024", "Growing Season 2024", "Fall Senescence 2024")))


season_counts <- 
  df_avg_23_24 %>%
  filter(season %in% c("Fall Senescence 2022", "Winter 2022", 
                       "Snow Melt 2023", "Growing Season 2023", 
                       "Fall Senescence 2023", "Winter 2023", 
                       "Snow Melt 2024", "Growing Season 2024", 
                       "Fall Senescence 2024")) %>%
  count(season) %>%
    arrange(factor(season, levels = c("Fall Senescence 2022", "Winter 2022", "Snow Melt 2023", "Growing Season 2023", "Fall Senescence 2023", "Winter 2023", "Snow Melt 2024", "Growing Season 2024", "Fall Senescence 2024")))


df_avg_biomet <- right_join(df_avg_biomet, season_counts, by = "season") 



gt(df_avg_biomet,
   rowname_col = "season",
   groupname_col = "year") %>% 
  tab_header(title = "Seasonal Averages",
             subtitle = "Sept. 15th, 2022 to Sept 15th, 2024") %>%
  cols_label(
    tair_with_se = md("Air Temp<br><span style='font-size:10pt'>(&deg;C)</span>"),
    tsoil5_with_se = md("5cm Soil Temp<br><span style='font-size:10pt'>(&deg;C)</span>"),
    swc_with_se = md("SWC<br><span style='font-size:10pt'>(m<sup>3</sup>m<sup>-3</sup>)</span>"),
    nee_with_se = md("NEE<br><span style='font-size:10pt'>(gCO<sub>2</sub>m<sup>-2</sup>d<sup>-1</sup>)</span>"),
    n = md("Length<br><span style='font-size:10pt'>(days)</span>")
  )%>%
  cols_width(
    stub() ~ px(150)
  )%>%
  tab_style(
    style = cell_text(align = "center"),
    locations = list(
      cells_body(),    # Center all data cells
      cells_column_labels() # Center all column labels
    )
  )





#averages yearly soil temps - not good data!! both 2022 and 2024 are incompete
df_avg_soil <- df_avg_23_24 %>%
  group_by(year) %>%
  summarize(
    tsoil5 = round(mean(TS_2_05_1, na.rm = TRUE), 2),
  tsoil5.se = round(std.error(TS_2_05_1, na.rm = TRUE), 2)
  )


```



### both years
```{r}


#Averages over each season within each year, and includes no. of days
df_avg_both <- df_avg_23_24 %>%
  group_by(season_name) %>%
  summarize(
    nee = round(mean(FC, na.rm = TRUE), 3),
    ch4 = round(mean(FCH4, na.rm = TRUE), 3),
    tair = round(mean(TA, na.rm = TRUE), 2),
    tsoil5 = round(mean(TS_2_05_1, na.rm = TRUE), 2),
    swc_1 = round(mean(SWC_1_1_1, na.rm = TRUE), 2),
    swc_2 = round(mean(SWC_2_1_1, na.rm = TRUE), 2),
    ws = round(mean(WS, na.rm = TRUE), 2),
    nee.se = round(std.error(FC, na.rm = TRUE), 2),
    ch4.se = round(std.error(FCH4, na.rm = TRUE), 2),
    tair.se = round(std.error(TA, na.rm = TRUE), 2),
    tsoil5.se = round(std.error(TS_2_05_1, na.rm = TRUE), 2),
    swc_1.se = round(std.error(SWC_1_1_1, na.rm = TRUE), 2),
    swc_2.se = round(std.error(SWC_2_1_1, na.rm = TRUE), 2),
    ws.se = round(std.error(WS, na.rm = TRUE), 2)
    ) %>%
  mutate(
    nee_with_se = paste0(nee, " ± ", nee.se),  # Combine value and SE
    ch4_with_se = paste0(ch4, " ± ", ch4.se),
    tair_with_se = paste0(tair, " ± ", tair.se),
    tsoil5_with_se = paste0(tsoil5, " ± ", tsoil5.se),
  swc_1_with_se = paste0(swc_1, " ± ", swc_1.se),
  swc_2_with_se = paste0(swc_2, " ± ", swc_2.se),
  ws_with_se = paste0(ws, " ± ", ws.se)
  )%>%
  select(season_name, nee_with_se, ch4_with_se, tair_with_se, tsoil5_with_se, swc_1_with_se,swc_2_with_se, ws_with_se) %>%
    arrange(factor(season_name, levels = c("Fall Senescence", "Winter", "Snow Melt", "Growing Season")))


```




# Soil temp heat map

## Create dataframe

```{r}

# Create new data frame for plot; one column is timestamp, one is soil temp depth, and one is numeric temperature value; 12 soil depths over two profiles in data set

#Creates numeric vector of the correct length with all of the soil temperature measurement depths in cm, repeated once for each row of data collected

# # To view all soil temperature variables in dataset
# print(grep("^TS_1", names(df), value = TRUE))

#Uses depth values in cm for easy coercion to numeric later
ts_columns <- rep(c("0", "10", "20", "30", "40", "50", "60", "70", "80", "90", "100"), nrow(df_23_24))

#Picks columns to move into new dataframe; 5 cm lost to make geom_raster work, could linearly interpolate or use geom_tile later?
df_soiltemp = select(df_23_24, TIMESTAMP, grep("^TS_1", names(df), value = TRUE), -TS_1_05_1) 

#Changes column names to line up with numeric depth values
colnames(df_soiltemp) = c("Time", "10", "0", "20", "30", "40", "50", "60", "70", "80", "90", "100")

# Uses linear interpolation to fill NAs in data to create smooth plot
for (col in c("10", "0", "20", "30", "40", "50", "60", "70", "80", "90", "100")) {
  df_soiltemp[[col]] <- na.locf(df_soiltemp[[col]], fromLast = TRUE) # Fill leading NAs
  df_soiltemp[[col]] <- na.locf(df_soiltemp[[col]]) # Fill trailing NAs
  df_soiltemp[[col]] <- na.approx(df_soiltemp[[col]])
}

#repeats every row of the dataframe 11 times
df_soiltemp <- df_soiltemp %>%
  slice(rep(1:n(), each = 11)) %>%
  bind_cols(ts_columns)

names(df_soiltemp)[13] <- "Depth"

#creates empty temp variable to fill with temp values
df_soiltemp$Temperature = NA


#Move corresponding temperature values into the temperature column, them remove unneccesary columns
df_soiltemp <- df_soiltemp %>%
  rowwise() %>%
  mutate(Temperature = ifelse(Depth %in% colnames(df_soiltemp), get(Depth), NA)) %>%
  ungroup() %>%
  select(-c("10", "0", "20", "30", "40", "50", "60", "70", "80", "90", "100"))

df_soiltemp$Depth = as.numeric(df_soiltemp$Depth)

summary(df_soiltemp)

# ### For testing
# 
# tsmin <- min(df_soiltemp$TIMESTAMP)
# tsmax <- max(df_soiltemp$TIMESTAMP)
# 
# ts <- data.frame(
#   TIMESTAMP = seq(as.POSIXct("2022-10-16 00:30:00"), as.POSIXct("2024-10-18 23:30:00"), by = "30 min")
# )
# 
# num = nrow(ts)*11
```

## Create Plot 

```{r}
# pal = c('red','orange','yellow','cyan','lightblue','blue','purple','violet')
# pal = c('violet','violet','purple','blue','lightblue','cyan','green','yellow','orange','red','red')
df_soiltemp$doy = format(df_soiltemp$Time,'%j')
df_soiltemp$year = format(df_soiltemp$Time,'%Y')

avg = df_soiltemp %>%
  group_by(doy,year,Depth) %>%
  summarise(Temperature = mean(Temperature,na.rm=T),
            Time = mean(Time,na.rm = T))
summary(avg)

# Creates new, continuous date column to use as X variable in the plot - time averaging was giving us weird gaps
avg$date = as.POSIXct(paste(avg$doy,avg$year,sep = "-"),format="%j-%Y",tz="UTC")

soiltemp <- ggplot(data = avg)+
  theme_bw()+
  aes(x=date, y=-Depth, fill= Temperature)+
  #geom_pointrange(aes(x= Time, y= -Depth, ymin = -100, ymax = 0, color = Temperature))+
  geom_raster(data = avg, interpolate = TRUE)+
  scale_fill_gradient2(low = c('pink','violet','purple','blue'),mid = 'cyan',high = c('green','yellow','orange','red'),midpoint = 0,
  limits = c(-15,20),
  breaks = c(-10, 0, 10, 20),
  labels = c("-10", "0", "10", "20+"),
  name = expression("Temperature ("*degree*"C)"),
  oob = scales::squish)+
  theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 14), legend.text = element_text(size = 12))+
  scale_y_continuous(name = "Depth (cm)",
    # trans = "reverse",  # Reverses the direction of the axis
    breaks = seq(0, -100, by = -10),  # Sets breaks for each 10 cm
    labels = seq(0, 100, by = 10),
    expand = c(0,0)
    )+
  scale_x_datetime(
    name = "",
    expand = c(0,0),
    breaks = seq(as.POSIXct("2022-10-01"), as.POSIXct("2024-10-01"), by = "3 months"),
                    date_labels = "%b %Y"
                   )
# #+
#   geom_vline(xintercept = as.POSIXct("2024-05-01"), color = "black", linewidth = 1.5)+
#   geom_vline(xintercept = as.POSIXct("2023-05-01"), color = "black", linewidth = 1.5)

soiltemp

#hist(df_soiltemp$Temperature)
##Stop temp scale at 20, make 20+ its own color to help with skew

# png(filename = './soiltempheatmap.png',width = 10,height = 4,units = 'in',res = 2000)
# soiltemp
# dev.off()
  

```
# Snowmelt peak analysis

### CO2
```{r}

## Shows non-temperature correlated peak in CO2 Flux data during snowmelt

## Very useful paper on this: https://doi.org/10.1002/2016GL071220


## May 15: DOY 135


co2_23 <- ggplot(data = df_avg_23_24) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 12),legend.position = 'none')+
  geom_point(aes(x = day, y = FC_night*60*60*(1/1000000)*12, color = 'Nighttime NEE')) +
  geom_line(aes(x = day, y = TS_2_05_1/200, color = '5cm Soil Temperature')) + 
  geom_line(aes(x= day, y= TA/200, color="Air Temperature"))+
  geom_hline(yintercept = 0) +
  ggtitle("Spring 2023")+
  scale_y_continuous(
    name = expression(atop("Nighttime NEE", "(g CO"[2]*"-C"~m^-2~h^-1~")")),
    limits = c(-0.1, 0.1),
    sec.axis = sec_axis(~.*200, name = expression("Temperature ("*degree*"C)"))
    ) +
  scale_x_datetime(limits = as.POSIXct(c('2023-04-01', '2023-07-01')), name = "", 
                   breaks = seq(as.POSIXct("2023-04-01"), as.POSIXct("2023-07-01"), by = "1 month"), date_labels = "%b %Y")+
  scale_color_manual(name = " ",
            values = c("Nighttime NEE" = "turquoise3",
                      "5cm Soil Temperature" = "navy",
                      "Air Temperature" = "salmon"),
            breaks = c("Nighttime NEE", "5cm Soil Temperature", "Air Temperature"))
co2_23


co2_24 <- ggplot(data = df_avg_23_24) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 12),legend.position = 'none')+
  geom_point(aes(x = day, y = FC_night*60*60*(1/1000000)*12, color = 'Carbon Flux')) +
  geom_line(aes(x = day, y = TS_2_05_1/200, color = '5cm Soil Temperature')) + 
  geom_line(aes(x= day, y= TA/200, color="Air Temperature"))+
  geom_hline(yintercept = 0) +
  ggtitle("Spring 2024")+
  scale_y_continuous(
    name = expression(atop("Nighttime NEE", "(g CO"[2]*"-C"~m^-2~h^-1~")")),
    limits = c(-0.1, 0.1),
    sec.axis = sec_axis(~.*200, name = expression("Temperature ("*degree*"C)"))
    ) +
  scale_x_datetime(limits = as.POSIXct(c('2024-04-01', '2024-07-01')), name = "", 
                   breaks = seq(as.POSIXct("2024-04-01"), as.POSIXct("2024-07-01"), by = "1 month"), date_labels = "%b %Y")+
  scale_color_manual(name = " ",
            values = c("Carbon Flux" = "turquoise3",
                      "5cm Soil Temperature" = "navy",
                      "Air Temperature" = "salmon"),
            breaks = c("Carbon Flux", "5cm Soil Temperature", "Air Temperature"))
co2_24


co2peak <- grid.arrange(co2_23, co2_24, nrow = 2)



# png(filename = './co2peak.png',width = 9.3,height = 5.9,units = 'in',res = 2000)
# grid.arrange(co2_23, co2_24, nrow = 2)
# dev.off()
# 


```


### CH4 

```{r}

ch4_23 <- ggplot(data = df_avg_23_24) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 12),legend.position = 'none')+
  geom_point(aes(x = day, y = FCH4*60*60*(1/1000000000)*12, color = 'Methane Flux')) +
  geom_line(aes(x = day, y = TS_2_05_1/5000, color = '5cm Soil Temperature')) + 
  geom_line(aes(x= day, y= TA/5000, color="Air Temperature"))+
  geom_hline(yintercept = 0) +
  ggtitle("Spring 2023")+
  scale_y_continuous(
    name = expression(atop("Methane Flux", "(g CH"[4]*"-C"~m^-2~h^-1~")")),
    limits = c(-0.004, 0.004),
    sec.axis = sec_axis(~.*5000, name = expression("Temperature ("*degree*"C)"))
    ) +
  scale_x_datetime(limits = as.POSIXct(c('2023-04-01', '2023-07-01')), name = "", 
                   breaks = seq(as.POSIXct("2023-04-01"), as.POSIXct("2023-07-01"), by = "1 month"), date_labels = "%b %Y")+
  scale_color_manual(name = " ",
            values = c("Methane Flux" = "turquoise3",
                      "5cm Soil Temperature" = "navy",
                      "Air Temperature" = "salmon"),
            breaks = c("Methane Flux", "5cm Soil Temperature", "Air Temperature"))
ch4_23


ch4_24 <- ggplot(data = df_avg_23_24) +
  theme_bw() +
  theme(axis.text.x = element_text(size = 12), axis.text.y = element_text(size = 12), 
  axis.title = element_text(size = 12),legend.position = 'none')+
  geom_point(aes(x = day, y = FCH4*60*60*(1/1000000000)*12, color = 'Methane Flux')) +
  geom_line(aes(x = day, y = TS_2_05_1/5000, color = '5cm Soil Temperature')) + 
  geom_line(aes(x= day, y= TA/5000, color="Air Temperature"))+
  geom_hline(yintercept = 0) +
  ggtitle("Spring 2024")+
  scale_y_continuous(
    name = expression(atop("Methane Flux", "(g CH"[4]*"-C"~m^-2~h^-1~")")),
    limits = c(-0.004, 0.004),
    sec.axis = sec_axis(~.*5000, name = expression("Temperature ("*degree*"C)"))
    ) +
  scale_x_datetime(limits = as.POSIXct(c('2024-04-01', '2024-07-01')), name = "", 
                   breaks = seq(as.POSIXct("2024-04-01"), as.POSIXct("2024-07-01"), by = "1 month"), date_labels = "%b %Y")+
  scale_color_manual(name = " ",
            values = c("Methane Flux" = "turquoise3",
                      "5cm Soil Temperature" = "navy",
                      "Air Temperature" = "salmon"),
            breaks = c("Methane Flux", "5cm Soil Temperature", "Air Temperature"))
ch4_24


ch4peak <- grid.arrange(ch4_23, ch4_24, nrow = 2)

# png(filename = './ch4peak.png',width = 9.3,height = 5.9,units = 'in',res = 2000)
# grid.arrange(ch4_23, ch4_24, nrow = 2)
# dev.off()


```




#  Temperature Relationship

Plots 6 and 7 for Ameriflux poster

### Create Exp. Model
```{r}

#Creates dataframe with both years of data
df_merge <- merge(df_avg_y1, df_avg_y2, by = "DOY", suffixes = c(".y1", ".y2"))

#2023

#co2
exp_model.y1 <- nls(FC_night.y1 ~ a * exp(b * TS_1_05_1.y1), data = df_merge, start = list(a = 1, b = 0.1))

# Generate predicted values
df_merge$predicted.y1 <- predict(exp_model.y1, newdata = df_merge)



#ch4
exp_model_ch4.y1 <- nls(FCH4.y1 ~ a * exp(b * TS_1_05_1.y1), data = df_merge, start = list(a = 1, b = 0.1))

# Generate predicted values
df_merge$predicted_ch4.y1 <- predict(exp_model_ch4.y1, newdata = df_merge)


#2024
exp_model.y2 <- nls(FC_night.y2 ~ a * exp(b * TS_1_05_1.y2), data = df_merge, start = list(a = 1, b = 0.1))

# Generate predicted values
df_merge$predicted.y2 <- predict(exp_model.y2, newdata = df_merge)

#ch4
exp_model_ch4.y2 <- nls(FCH4.y2 ~ a * exp(b * TS_1_05_1.y2), data = df_merge, start = list(a = 1, b = 0.1))

# Generate predicted values
df_merge$predicted_ch4.y2 <- predict(exp_model_ch4.y2, newdata = df_merge)


```


### Plots
```{r}

#Plots flux variables vs. 5cm soil temp to visualize temperature/co2 flux relationship

## Temp relationship plots with daily averages

# FC_night vs. soil temp; used to estimate RECO without temp correlation or gap filling

co2model <- ggplot(data=df_merge)+
  theme_bw()+
  geom_hline(yintercept = 0)+
  geom_vline(xintercept = 0)+
  geom_point(aes(x=TS_1_05_1.y1, y=FC_night.y1, col = DOY, shape = "Year 1"))+
  geom_point(aes(x=TS_1_05_1.y2, y=FC_night.y2, col = DOY, shape = "Year 2"))+
  geom_line(aes(x = TS_1_05_1.y1, y = predicted.y1, linetype = "Year 1"))+
  geom_line(aes(x = TS_1_05_1.y2, y = predicted.y2, linetype = "Year 2"))+
scale_color_gradient(low = "navy", high = "salmon")+
  scale_shape_manual(values = c("Year 1" = 16, "Year 2" = 17))+
  scale_linetype_manual(values = c("Year 1" = "solid", "Year 2" = "dashed"))+
  labs(
    x = expression("5cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly nighttime CO"[2] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("Nighttime CO"[2] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits=c(-11,15))+
  scale_y_continuous(limits=c(-0.5,2.5))

co2model

# png(filename = './co2model.png',width = 9.3,height = 5.9,units = 'in',res = 2000)
# co2model
# dev.off()

#Methane vs. soil temp

ch4model <- ggplot(data=df_merge)+
  geom_vline(xintercept=0)+
  theme_bw()+
  geom_point(aes(x=TS_1_05_1.y1, y=FCH4.y1*(1/1000), col = DOY, shape = "Year 1"))+
  geom_point(aes(x=TS_1_05_1.y2, y=FCH4.y2*(1/1000), col = DOY, shape = "Year 2"))+
  geom_line(aes(x = TS_1_05_1.y1, y = predicted_ch4.y1*(1/1000), linetype = "Year 1"))+
  geom_line(aes(x = TS_1_05_1.y2, y = predicted_ch4.y2*(1/1000), linetype = "Year 2"))+
scale_color_gradient(low = "navy", high = "salmon")+
scale_linetype_manual(values = c("Year 1" = "solid", "Year 2" = "dashed"))+
  labs(
    x = expression("5cm Soil Temperature ("*degree*"C)"),
    y = expression("Half-hourly CH"[4] * " Flux ("*mu*mol~m^-2~s^-1*")"),
    title = expression("CH"[4] * " Flux vs. Soil Temperature")
  )+
  scale_x_continuous(limits = c(-11, 15))+
  scale_y_continuous(limits = c(-0.02, .10))+
  scale_shape_manual(values = c("Year 1" = 16, "Year 2" = 17))

ch4model

# png(filename = './ch4model.png',width = 9.3,height = 5.9,units = 'in',res = 2000)
# ch4model
# dev.off()


```

# Biomet Var Plots
```{r}

df_avg_winter <- df_avg_23_24[df_avg_23_24$season %in% c("Winter 2024", "Winter 2023"), ]

df_avg_winter$D_SNOW[19] <- NA

## Add day of winter column by subtracting/adding to DOY, custom add dates (Jan 1, Feb 1)

## Day 1 of winter = DOY 300
df_avg_winter$DOW <- df_avg_winter$DOY

for (i in seq_len(nrow(df_avg_winter))) {
  if (df_avg_winter$DOY[i] > 300) {
    
    df_avg_winter$DOW[i] <- df_avg_winter$DOW[i] - 300
  }
  
  if (df_avg_winter$DOY[i] <= 300 & df_avg_winter$DOY[i] > 200) {
    
    df_avg_winter$D_SNOW[i] <- NA
  }

  
  if (df_avg_winter$DOY[i] <= 300) {
    
    df_avg_winter$DOW[i] <- df_avg_winter$DOW[i] + 65
  }
}

#dataframe to label days of winter as months

first_of_month <- data.frame(
  DOW = c(65, 96, 124, 155, 185, 216, 246, 277, 308, 338, 4, 34),
  Label = c("Jan 1", "Feb 1", "Mar 1", "Apr 1", "May 1", "Jun 1", "Jul 1", "Aug 1", "Sep 1", "Oct 1", "Nov 1", "Dec 1")
)

ggplot(data = df_avg_winter)+
  theme_bw()+
  geom_line(aes(x = DOW, y = TS_1_1_1, color = year))+
  geom_line(aes(x = DOW, y = TA, color = year), linetype = "dashed")+
  scale_x_continuous(limits = c(0, 200),
    breaks = first_of_month$DOW,
    labels = first_of_month$Label)+     scale_color_manual(name = " ",
            values = c("2022" = "salmon", 
                      "2023" = "turquoise3"),
            breaks = c("2022", "2023"))+ 
  labs(
    x = expression(" "),
    y = expression("Temp ("*degree*"C)")
  )

ggplot(data = df_avg_winter)+
  theme_bw()+
  geom_line(aes(x = DOW, y = D_SNOW, color = year))+
  geom_line(aes(x = DOW, y = WS, color = year), linetype = "dashed")+
  scale_x_continuous(limits = c(0, 200),
    breaks = first_of_month$DOW,
    labels = first_of_month$Label)+     scale_color_manual(name = " ",
            values = c("2022" = "salmon", 
                      "2023" = "turquoise3"),
            breaks = c("2022", "2023"))+ 
  labs(
    x = expression(" "),
    #y = expression("Temp ("*degree*"C)")
  )


```

### Stacked plots
```{r}

ggplot(data = df_avg_23_24, aes(x=day))+
  theme_bw()+
  #geom_line(aes(y = NETRAD, color = "Net Radiation"))+
  geom_line(aes(y = LW_IN, linetype = "In", color = "Longwave"), size = 0.4) +
    geom_line(aes(y = LW_OUT, linetype = "Out", color = "Longwave"), size = 0.4) +
  geom_line(aes(y = SW_IN, linetype = "In", color = "Shortwave"), size = 0.4)+
    geom_line(aes(y = SW_OUT, linetype = "Out", color = "Shortwave"), size = 0.4) +
  geom_line(aes(y = PPFD_IN,, linetype = "In", color = "PAR"), size = 0.4)+
    geom_line(aes(y = PPFD_OUT, linetype = "Out", color = "PAR"), size = 0.4) +
  geom_hline(yintercept=0, col="black")+
  scale_y_continuous(expression('Radiation (W'~m^-2*')'))+
  #sec.axis = sec_axis(~ . /13, name = expression('CH'[4]*' Flux (g C'~m^-2~d^-1*')')))+
  scale_color_manual(name = " ",
            values = c(
                      "Longwave" = "navy", 
                      "Shortwave" = "salmon", 
                      "PAR" = "cyan"),
            breaks = c("Longwave", "Shortwave", "PAR"))+
  scale_linetype_manual(name = " ",
            values = c(
                      "In" = "solid", 
                      "Out" = "dotted"),
            breaks = c("In", "Out"))+
  scale_x_datetime(name = expression(""), 
                   breaks = seq(as.POSIXct("2022-10-01"), as.POSIXct("2024-10-01"), by = "3 months"),
                   date_labels = "%b %Y")

LW <- ggplot(data = df_avg_23_24, aes(x=day))+
  theme_bw()+
  #geom_line(aes(y = NETRAD, color = "Net Radiation"))+
  geom_line(aes(y = LW_IN, color = "In")) +
    geom_line(aes(y = LW_OUT, color = "Out"))+
theme(axis.text.x = element_text(size = 11), axis.text.y = element_text(size = 11), 
  axis.title = element_text(size = 13),legend.position = 'none')+
    scale_y_continuous(expression('Longwave\nRadiation (W'~m^-2*')'))+
  scale_color_manual(name = " ",
            values = c(
                      "In" = "cyan", 
                      "Out" = "salmon"),
            breaks = c("In", "Out"))+
  scale_x_datetime(expand = expansion(mult = 0), name = expression(""), 
                   breaks = seq(as.POSIXct("2022-10-01"), as.POSIXct("2024-10-01"), by = "3 months"),
                   date_labels = "%b %Y")

SW <- ggplot(data = df_avg_23_24, aes(x=day))+
  theme_bw()+
  #geom_line(aes(y = NETRAD, color = "Net Radiation"))+
  geom_line(aes(y = SW_IN, color = "In")) +
    geom_line(aes(y = SW_OUT, color = "Out"))+
    scale_y_continuous(expression('Shortwave\nRadiation (W'~m^-2*')'))+
  scale_color_manual(name = " ",
            values = c(
                      "In" = "cyan", 
                      "Out" = "salmon"),
            breaks = c("In", "Out"))+
  scale_x_datetime(expand = expansion(mult = 0), name = expression(""), 
                   breaks = seq(as.POSIXct("2022-10-01"), as.POSIXct("2024-10-01"), by = "3 months"),
                   date_labels = "%b %Y")

PAR <- ggplot(data = df_avg_23_24, aes(x=day))+
  theme_bw()+
  #geom_line(aes(y = NETRAD, color = "Net Radiation"))+
  geom_line(aes(y = PPFD_IN, color = "In")) +
    geom_line(aes(y = PPFD_OUT, color = "Out"))+
    scale_y_continuous(expression('PPFD (W'~m^-2*')'))+
  scale_color_manual(name = " ",
            values = c(
                      "In" = "cyan", 
                      "Out" = "salmon"),
            breaks = c("In", "Out"))+
  scale_x_datetime(expand = expansion(mult = 0), name = expression(""), 
                   breaks = seq(as.POSIXct("2022-10-01"), as.POSIXct("2024-10-01"), by = "3 months"),
                   date_labels = "%b %Y")

plot_grid(LW, SW, PAR, ncol = 1)
```


### Soil Temp Timeseries Plot
```{r}
soiltempts <- ggplot(data = df_avg_23_24)+ theme_bw()+
  geom_hline(yintercept = 0)+
  geom_line(aes(day,TS_2_0_1,color='0 cm'))+
  geom_line(aes(day,TS_2_05_1,color='5 cm'))+
  geom_line(aes(day,TS_2_1_1,color='10 cm'))+
  geom_line(aes(day,TS_2_2_1,color='20 cm'))+  
  geom_line(aes(day,TS_2_3_1,color='30 cm'))+
  geom_line(aes(day,TS_2_4_1,color='40 cm'))+
  geom_line(aes(day,TS_2_5_1,color='50 cm'))+
  geom_line(aes(day,TS_2_6_1,color='60 cm'))+
  geom_line(aes(day,TS_2_7_1,color='70 cm'))+
  geom_line(aes(day,TS_2_8_1,color='80 cm'))+
  geom_line(aes(day,TS_2_9_1,color='90 cm'))+
  geom_line(aes(day,TS_2_10_1,color='100 cm'))+
  scale_y_continuous(expression("Soil Temperature ("*degree*"C)"))+
  scale_x_datetime(name = expression(""), 
                   breaks = seq(as.POSIXct("2022-10-01"), as.POSIXct("2024-10-01"), by = "3 months"),
                   date_labels = "%b %Y") +
  scale_color_manual(values = c("0 cm" = "darkgreen", "5 cm" = "pink", "10 cm" = "blue", "20 cm" = "orange", "30 cm" = "hotpink", "40 cm" = "tan", "50 cm" = "brown", "60 cm" = "purple", "70 cm" = "cyan", "80 cm" = "magenta", "90 cm" = "yellow", "100 cm" = "gray"),breaks = c("0 cm", "5 cm", "10 cm", "20 cm", "30 cm", "40 cm", "50 cm", "60 cm", "70 cm", "80 cm", "90 cm", "100 cm"), guide = guide_legend(title = NULL))


png(filename = './soiltempts.png',width = 10.96,height = 3.67,units = 'in',res = 2000)
soiltempts
dev.off()
```


### SWC Plot
```{r}

ggplot(data = df_avg_23_24)+ theme_bw()+
  geom_hline(yintercept = 0)+
  geom_line(aes(day,SWC_1_1_1,color='SWC 1'))+
  geom_line(aes(day,SWC_2_1_1,color='SWC 2'))+
  geom_line(aes(day,SWC_2_2_1,color='SWC 2'))+
  scale_y_continuous(expression('Soil Temperature'))+
  scale_x_datetime(name = expression(""), 
                   breaks = seq(as.POSIXct("2022-10-01"), as.POSIXct("2024-10-01"), by = "3 months"),
                   date_labels = "%b %Y") 

```