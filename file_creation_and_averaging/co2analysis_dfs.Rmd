---
title: "Two Year Data Loading"
author: "Dani Trangmoe"
date: "`r Sys.Date()`"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/dtrangmoe/Documents/github/churchill_carbon_flux_paper/') #use this to set your directory
```

# Load Data 

from cf1_cf3_merge

```{r}

rm(list = ls())
Sys.setenv(TZ = "UTC")

df = fread('./output_files/Churchill_Merged_CF1_CF3_HH_25.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))


df_avg = fread('./output_files/Churchill_Merged_Avg_CF1_CF3_HH_25.csv',na.strings = c('-9999','NA','NaN','NAN','-7999'))

#Creates data frames of each year containing the daily averages of each value- useful for focusing on one year at a time

df_avg$day <- as.POSIXct(df_avg$date, format = "%Y-%m-%d")
df$day <- as.POSIXct(df$date, format = "%Y-%m-%d")

df$DOY <- yday(df$TIMESTAMP)
df_avg$DOY <- yday(df_avg$date)
summary(df_avg$DOY)

```

# Select only time period we're looking at

```{r}

# #Both (both years of data, beginning at the beginning of fall 2022 and ending at the end of fall 2024. makes two full seasonal cycles of data)

df_avg_23_24_25 <- subset(df_avg, ((df_avg$date > as.POSIXct("2022-09-18 00:00")) & (df_avg$date < as.POSIXct("2025-09-10 00:00"))))

df_23_24_25 <- subset(df, ((df$TIMESTAMP > as.POSIXct("2022-09-18 00:00")) & (df$TIMESTAMP < as.POSIXct("2025-09-10 00:00"))))



```

Plot for visualizing seasonal changes
```{r}

# Using fluxes

ggplot(data = df_avg_23_24_25)+
  geom_hline(yintercept = 0)+
  geom_point(aes(date, FC))+
  scale_x_date(limits = as.Date(c('2025-05-01','2025-07-20')))+
  geom_vline(xintercept = as.Date("2025-06-16"), col = "red")

# Using air temp

ggplot(data = df_avg_23_24_25)+
  geom_hline(yintercept = 0)+
  geom_point(aes(date, TA))+
  scale_x_date(limits = as.Date(c('2025-04-01','2025-06-30')))+
  geom_vline(xintercept = as.Date("2025-05-21"), col = "red")

```

# Definitions of seasons

Last days:

Start of fall 1: 09-18-2022; DOY 
End of fall 1: 10-15-2022; DOY 288
end of winter 1, 05-04-23
end of snowmelt 1, 06-11-23
end of growing season 1, 09-05-23

end of fall 2, 10-21-23
End of winter 2: 05-14-2024; DOY 135
End of snowmelt 2: 06-17-2024; DOY 169
End of growing season 2: 09-12-2024; DOY 256

End of fall 3: 10-19-24; DOY 293
End of winter 3:05-21-2025 ; DOY 
End of snowmelt 3: 06-16-2025 ; DOY 
End of growing season 3: 09-10-25; DOY


```{r}

df_avg_23_24_25 <- df_avg_23_24_25 %>%
  mutate(
      season = case_when(
      (date <= as.POSIXct("2022-10-15")) ~ 'Fall Senescence 2022',
      
      (date >= as.POSIXct("2022-10-16") & date <= as.POSIXct("2023-05-04")) ~ 'Winter 2023',
      
      (date >= as.POSIXct("2023-05-05") & date <= as.POSIXct("2023-06-11")) ~ 'Snow Melt 2023',
      
      (date >= as.POSIXct("2023-06-12") & date <= as.POSIXct("2023-09-05")) ~ 'Growing Season 2023',
      
      (date >= as.POSIXct("2023-09-06") & date <= as.POSIXct("2023-10-21")) ~ 'Fall Senescence 2023',
      
      (date >= as.POSIXct("2023-10-22") & date <= as.POSIXct("2024-05-14")) ~ 'Winter 2024',
      
      (date >= as.POSIXct("2024-05-15") & date <= as.POSIXct("2024-06-17")) ~ 'Snow Melt 2024',
      
      (date >= as.POSIXct("2024-06-18") & date <= as.POSIXct("2024-09-12")) ~ 'Growing Season 2024',
      
      (date >= as.POSIXct("2024-09-13") & date <= as.POSIXct("2024-10-19")) ~ 'Fall Senescence 2024',
      
      (date >= as.POSIXct("2024-10-19") & date <= as.POSIXct("2025-05-21"))~ 'Winter 2025',
      
      (date >= as.POSIXct("2024-05-22") & date <= as.POSIXct("2024-06-16")) ~ 'Snow Melt 2025',

      (date >= as.POSIXct("2024-06-17")) ~ 'Growing Season 2025',
      TRUE ~ NA_character_
    )
  )


# Definition of seasons in the half-hourly dataframe 

df_23_24_25 <- df_23_24_25 %>%
  mutate(
    season = case_when(
      (date <= as.POSIXct("2022-10-15")) ~ 'Fall Senescence 2022',
      
      (date >= as.POSIXct("2022-10-16") & date <= as.POSIXct("2023-05-04")) ~ 'Winter 2023',
      
      (date >= as.POSIXct("2023-05-05") & date <= as.POSIXct("2023-06-11")) ~ 'Snow Melt 2023',
      
      (date >= as.POSIXct("2023-06-12") & date <= as.POSIXct("2023-09-05")) ~ 'Growing Season 2023',
      
      (date >= as.POSIXct("2023-09-06") & date <= as.POSIXct("2023-10-21")) ~ 'Fall Senescence 2023',
      
      (date >= as.POSIXct("2023-10-22") & date <= as.POSIXct("2024-05-14")) ~ 'Winter 2024',
      
      (date >= as.POSIXct("2024-05-15") & date <= as.POSIXct("2024-06-17")) ~ 'Snow Melt 2024',
      
      (date >= as.POSIXct("2024-06-18") & date <= as.POSIXct("2024-09-12")) ~ 'Growing Season 2024',
      
      (date >= as.POSIXct("2024-09-13") & date <= as.POSIXct("2024-10-19")) ~ 'Fall Senescence 2024',
      
      (date >= as.POSIXct("2024-10-19") & date <= as.POSIXct("2025-05-21"))~ 'Winter 2025',
      
      (date >= as.POSIXct("2025-05-22") & date <= as.POSIXct("2025-06-16")) ~ 'Snow Melt 2025',

      (date >= as.POSIXct("2025-06-17")) ~ 'Growing Season 2025',
      TRUE ~ NA_character_
    )
  )


#splits season names into name and year cols
df_avg_23_24_25 <- df_avg_23_24_25 %>%
  mutate(
    season_name = str_extract(season, "^[^0-9]+"), # Extract the season name
    season_year = str_extract(season, "\\d{4}")          # Extract the 4-digit year
  )


#splits season names into name and year cols
df_23_24_25 <- df_23_24_25 %>%
  mutate(
    season_name = str_extract(season, "^[^0-9]+"), # Extract the season name
    season_year = str_extract(season, "\\d{4}")          # Extract the 4-digit year
  )
```

Creates year number to group even years together
```{r}

df_23_24_25 <- df_23_24_25 %>%
  mutate(
    full_year = case_when(
      (season %in% c('Fall Senescence 2022', 'Winter 2023', 'Snow Melt 2023', 'Growing Season 2023') ~ 1),
      (season %in% c('Fall Senescence 2023','Winter 2024','Snow Melt 2024','Growing Season 2024') ~ 2),
      (season %in% c('Fall Senescence 2024','Winter 2025','Snow Melt 2025','Growing Season 2025') ~ 3)
    )
  )

df_avg_23_24_25 <- df_avg_23_24_25 %>%
  mutate(
    full_year = case_when(
      (season %in% c('Fall Senescence 2022', 'Winter 2023', 'Snow Melt 2023', 'Growing Season 2023') ~ 1),
      (season %in% c('Fall Senescence 2023','Winter 2024','Snow Melt 2024','Growing Season 2024') ~ 2),
      (season %in% c('Fall Senescence 2024','Winter 2025','Snow Melt 2025','Growing Season 2025') ~ 3)
    )
  )


```


#Breaks dataframes up into three year-long dataframes, each containing a full seasonal cycle 
```{r}
## For two year budget, broken up at end of fall y1

df_y1 <- subset(df_23_24_25, (df_23_24_25$full_year == 1))

df_avg_y1 <- subset(df_avg_23_24_25, (df_avg_23_24_25$full_year == 1))



df_y2 <- subset(df_23_24_25, (df_23_24_25$full_year == 2))

df_avg_y2 <- subset(df_avg_23_24_25, (df_avg_23_24_25$full_year == 2))


df_y3 <- subset(df_23_24_25, (df_23_24_25$full_year == 3))

df_avg_y3 <- subset(df_avg_23_24_25, (df_avg_23_24_25$full_year == 3))
```



# Save off each dataframe

```{r}

#FOR ALL DATAFRAMES: Units of CO2 flux are micromoles of CO2/(m^2s), units of CH4 flux are nanomoles of CH4/(m^2s)


# Both years of data
write.csv(x = df_23_24_25,file = './output_files/three_years_HH.csv',row.names = F,quote = F)
write.csv(x = df_avg_23_24_25,file = './output_files/three_years_daily_avg.csv',row.names = F,quote = F)

# Year 1
write.csv(x = df_y1,file = './output_files/year1_HH.csv',row.names = F,quote = F)
write.csv(x = df_avg_y1,file = './output_files/year1_daily_avg.csv',row.names = F,quote = F)

# Year 2
write.csv(x = df_y2,file = './output_files/year2_HH.csv',row.names = F,quote = F)
write.csv(x = df_avg_y2,file = './output_files/year2_daily_avg.csv',row.names = F,quote = F)

# Year 3
write.csv(x = df_y3,file = './output_files/year3_HH.csv',row.names = F,quote = F)
write.csv(x = df_avg_y3,file = './output_files/year3_daily_avg.csv',row.names = F,quote = F)

```


