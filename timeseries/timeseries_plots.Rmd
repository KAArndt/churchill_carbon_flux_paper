---
title: "timeseries_plots"
author: "Dani Trangmoe"
date: "`r Sys.Date()`"
output: html_document
---

```{r}

rm(list = ls())
Sys.setenv(TZ = "UTC")

library(data.table)
library(ggplot2)
library(lubridate)
library(tidyverse)
library(gridExtra) 
library(patchwork)
library(plotrix) # standard error function

```

Load Dataframe
```{r}

df_avg_23_24 <- fread('./output_files/three_years_daily_avg.csv')
df_23_24 <- fread("./output_files/three_years_HH.csv")

```

# Carbon Timeseries

Timeseries of GPP, ER, NEE, and CH4

```{r}

carbonts <- ggplot(data = df_avg_23_24, aes(x=date))+
  theme_bw()+
  geom_line(aes(y = GPP_F*60*60*24*(1/1e6)*12, color = "GPP"))+
  geom_line(aes(y = RECO*60*60*24*(1/1e6)*12, color = "Respiration")) +
  geom_point(aes(y = FC_F*60*60*24*(1/1e6)*12, color = "NEE", shape = "Gapfilled"))+
  geom_point(aes(y = FC*60*60*24*(1/1e6)*12, color = "NEE", shape = "Measured"))+
  geom_hline(yintercept=0, col="black")+
  scale_y_continuous(limits = c(-3.8, 4), expression('NEE (gC-CO'[2]~m^-2~d^-1*')'))+
  scale_x_date(name = NULL,
                   breaks = seq(as.Date("2022-09-01"), as.Date("2025-09-01"), by = "4 months"), date_labels = "%b %Y")+
  scale_shape_manual(name = NULL,
            values = c("Gapfilled" = 1, 
                      "Measured" = 16),
            breaks = c("Gapfilled", "Measured"))+
  scale_color_manual(name = NULL,
            values = c("Methane Flux" = "mediumorchid", "GPP" = "salmon", 
                      "Respiration" = "turquoise3", 
                      "NEE" = "navy"),
            breaks = c("NEE",
              "GPP", "Respiration"))

carbonts

methanets <- ggplot(data = df_avg_23_24, aes(x=date))+
  theme_bw()+
  geom_point(aes(y = FCH4_F*60*60*24*(1/1e9)*12*13, color = "Methane Flux", shape = "Gapfilled"))+
  geom_point(aes(y = FCH4*60*60*24*(1/1e9)*12*13, color = "Methane Flux", shape = "Measured"))+
  geom_hline(yintercept=0, col="black")+
  scale_y_continuous(limits = c(-0.3, 1.5), expression('CH'[4]*' Flux (gC-CH'[4]~m^-2~d^-1*')'))+
  scale_x_date(name = NULL,
                   breaks = seq(as.Date("2022-09-01"), as.Date("2025-09-01"), by = "4 months"),
                   date_labels = "%b %Y")+
  scale_shape_manual(name = NULL,
            values = c("Gapfilled" = 1, 
                      "Measured" = 16),
            breaks = c("Gapfilled", "Measured"))+
  scale_color_manual(name = NULL, values = c("Methane Flux" = "mediumorchid", "GPP" = "salmon", 
                      "Respiration" = "turquoise3", 
                      "NEE" = "navy"))

methanets

png(filename = './png/fluxts.png',width = 10,height = 6,units = 'in',res = 2000)
carbonts/methanets + plot_layout(guides = "collect", axes = "collect")
dev.off()

```


# Soil Temp Timeseries 

```{r}

soiltempts <- ggplot(data = df_avg_23_24)+ theme_bw()+
  geom_hline(yintercept = 0)+
  geom_line(aes(day,TS_2_0_1,color='0 cm'))+
  geom_line(aes(day,TS_2_05_1,color='5 cm'))+
  geom_line(aes(day,TS_2_1_1,color='10 cm'))+
  geom_line(aes(day,TS_2_2_1,color='20 cm'))+  
  geom_line(aes(day,TS_2_3_1,color='30 cm'))+
  geom_line(aes(day,TS_2_4_1,color='40 cm'))+
  geom_line(aes(day,TS_2_5_1,color='50 cm'))+
  geom_line(aes(day,TS_2_6_1,color='60 cm'))+
  geom_line(aes(day,TS_2_7_1,color='70 cm'))+
  geom_line(aes(day,TS_2_8_1,color='80 cm'))+
  geom_line(aes(day,TS_2_9_1,color='90 cm'))+
  geom_line(aes(day,TS_2_10_1,color='100 cm'))+
  scale_y_continuous(expression("Soil Temperature ("*degree*"C)"))+
  scale_x_date(name = expression(""), 
                   breaks = seq(as.Date("2022-10-01"), as.Date("2025-10-01"), by = "3 months"),
                   date_labels = "%b %Y") +
  scale_color_manual(values = c("0 cm" = "darkgreen", "5 cm" = "pink", "10 cm" = "blue", "20 cm" = "orange", "30 cm" = "hotpink", "40 cm" = "tan", "50 cm" = "brown", "60 cm" = "purple", "70 cm" = "cyan", "80 cm" = "magenta", "90 cm" = "yellow", "100 cm" = "gray"),breaks = c("0 cm", "5 cm", "10 cm", "20 cm", "30 cm", "40 cm", "50 cm", "60 cm", "70 cm", "80 cm", "90 cm", "100 cm"), guide = guide_legend(title = NULL))

# soiltempts
# 
# png(filename = './png/soiltempts.png',width = 10.96,height = 3.67,units = 'in',res = 2000)
# soiltempts
# dev.off()
```

# Winter Timeseries

Create winter dataframe 
```{r}



df_avg_winter <- df_avg_23_24[df_avg_23_24$season %in% c("Winter 2025", "Winter 2024", "Winter 2023"), ]

df_avg_winter$D_SNOW[19] <- NA

## Add day of winter column by subtracting/adding to DOY, custom add dates (Jan 1, Feb 1)

## Day 1 of winter = DOY 300
df_avg_winter$DOW <- df_avg_winter$DOY

for (i in seq_len(nrow(df_avg_winter))) {
  if (df_avg_winter$DOY[i] > 300) {
    
    df_avg_winter$DOW[i] <- df_avg_winter$DOW[i] - 300
  }
  
  if (df_avg_winter$DOY[i] <= 300 & df_avg_winter$DOY[i] > 200) {
    
    df_avg_winter$D_SNOW[i] <- NA
  }

  
  if (df_avg_winter$DOY[i] <= 300) {
    
    df_avg_winter$DOW[i] <- df_avg_winter$DOW[i] + 65
  }
}

#dataframe to label days of winter as months

first_of_month <- data.frame(
  DOW = c(65, 96, 124, 155, 185, 216, 246, 277, 308, 338, 4, 34),
  Label = c("Jan 1", "Feb 1", "Mar 1", "Apr 1", "May 1", "Jun 1", "Jul 1", "Aug 1", "Sep 1", "Oct 1", "Nov 1", "Dec 1")
)

df_avg_winter$season_year <- as.factor(df_avg_winter$season_year)

df_avg_winter$airdiff <- df_avg_winter$TA-df_avg_winter$TS_2_05_1

```

Create monthly averages of winter data

```{r}

df_avg_winter$month <- month(df_avg_winter$date)
summary(df_avg_winter$month)


df_monthly_avg_winter <- df_avg_winter %>%
  group_by(month, full_year)%>%
  summarize(
    nee = round(mean(FC, na.rm = TRUE), 3),
    tair = round(mean(TA, na.rm = TRUE), 2),
    tsoil5 = round(mean(TS_2_05_1, na.rm = TRUE), 2),
    swc = round(mean(SWC_1_1_1, na.rm = TRUE), 2),
    ws = round(mean(WS, na.rm = TRUE), 2),
    ch4 = round(mean(FCH4, na.rm = TRUE), 2), # other variables kept as artifact from old code, maybe add back later
    nee.se = round(std.error(FC, na.rm = TRUE), 2),
    tair.se = round(std.error(TA, na.rm = TRUE), 2),
    tsoil5.se = round(std.error(TS_2_05_1, na.rm = TRUE), 2),
    swc.se = round(std.error(SWC_1_1_1, na.rm = TRUE), 2),
    ws.se = round(std.error(WS, na.rm = TRUE), 2),
    ch4.se = round(std.error(FCH4, na.rm = TRUE), 2)
    ) %>%
  select(c(full_year, month, tair, tair.se, tsoil5, tsoil5.se)) %>%
  pivot_wider(names_from = full_year, values_from = c(tair, tair.se, tsoil5, tsoil5.se))



tair <- ggplot(data = df_monthly_avg_winter)+
  theme_bw()+
  theme(
    plot.background = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 12, angle = 45, hjust = 1), axis.text.y = element_text(size = 12), 
  axis.title.y = element_text(size = 14),axis.title.x = element_blank(),
  legend.position = "none")+
  geom_line(aes(x = month, y = tair_1, color = "1"))+
  geom_line(aes(x = month, y = tair_2, color = "2"))+
  geom_line(aes(x = month, y = tair_3, color = "3"))+
  geom_point(aes(x = month, y = tair_1, color = "1"))+
  geom_point(aes(x = month, y = tair_2, color = "2"))+
  geom_point(aes(x = month, y = tair_3, color = "3"))+
  geom_errorbar(
    aes(x = month,
        ymin = tair_1 - tair.se_1,
        ymax = tair_1 + tair.se_1,
        color = "1"),
    width = 0.3
  )+
  geom_errorbar(
    aes(x = month,
        ymin = tair_2 - tair.se_2,
        ymax = tair_2 + tair.se_2,
        color = "2"),
    width = 0.3
  )+
    geom_errorbar(
    aes(x = month,
        ymin = tair_3 - tair.se_3,
        ymax = tair_3 + tair.se_3,
        color = "3"),
    width = 0.3
  )+    
  geom_hline(aes(yintercept = 0, color = "black"))+
  scale_x_continuous(breaks = 1:12, labels = month.abb)+
  scale_y_continuous(expression('Air Temperature ('*degree*'C)'))+
  scale_color_manual(name = " ",
            values = c("1" = "turquoise3", 
                      "2" = "salmon",
                      "3" = "navy"),
            breaks = c("1", "2", "3"))
```

# Plot
```{r}


#needs axis labels for dashed-dotted line
winterts <- ggplot(data = df_avg_winter)+
  theme_bw()+
  guides(
    color = guide_legend(order = 1),     # appears first (top)
    linetype = guide_legend(order = 2)   # appears second (below)
  )+
  geom_hline(aes(yintercept = 0))+
  geom_line(aes(x = DOW, y = TS_2_05_1, color = season_year, linetype = "Soil Temp"))+
  geom_line(aes(x = DOW, y = TA, color = season_year, linetype = "Air Temp"), alpha = 0.4)+
  scale_x_continuous(limits = c(0, 200),
    breaks = first_of_month$DOW,
    labels = first_of_month$Label)+ 
  scale_linetype_manual(name = " ",
                        values = c("Soil Temp" = "solid",
                          "Air Temp"="twodash"))+
  scale_color_manual(name = " ",
            values = c("2025" = "navy",
                      "2024" = "salmon",
                      "2023" = "turquoise3"),
            breaks = c("2023", "2024", "2025"))+
  labs(
    x = expression(" "),
    y = expression("Temperature ("*degree*"C)")
  )

winterts

# # Ambient temp is dominant trend here, not interesting
# ggplot(data = df_avg_winter)+
#   theme_bw()+
#   geom_line(aes(x = DOW, y = airdiff, color = year))+
#   scale_x_continuous(limits = c(0, 200),
#     breaks = first_of_month$DOW,
#     labels = first_of_month$Label)+
#   scale_color_manual(name = " ",
#             values = c("2024" = "salmon",
#                       "2023" = "turquoise3"),
#             breaks = c("2024", "2023"))+
#   labs(
#     x = expression(" "),
#     y = expression("Temp ("*degree*"C)")
#   )

wintersd <- ggplot(data = df_avg_winter)+
  theme_bw()+
  guides(
    color = guide_legend(order = 1),
    linetype = guide_legend(order = 2)
  )+
  geom_line(aes(x = DOW, y = D_SNOW, color = season_year), show.legend = FALSE)+
  scale_x_continuous(limits = c(0, 200),
    breaks = first_of_month$DOW,
    labels = first_of_month$Label)+     
  scale_color_manual(name = " ",
            values = c("2025" = "navy",
                      "2024" = "salmon", 
                      "2023" = "turquoise3"),
            breaks = c("2023", "2024", "2025"))+ 
  labs(
    x = expression(" "),
    y = expression("Snow Depth (cm)")
  )

wintersd

png(filename = './png/winterts.png',width = 8,height = 6,units = 'in',res = 2000)
wintersd / winterts + plot_layout(guides = "collect", axes = "collect")
dev.off()


```


